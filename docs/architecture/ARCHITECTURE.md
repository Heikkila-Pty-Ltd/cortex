# Cortex Architecture

> Deep technical reference for the Cortex execution engine, CHUM learning loop, and Temporal workflow topology.

---

## System Overview

Cortex is a **durable, self-healing agent orchestrator** composed of three layers:

```mermaid
graph LR
    subgraph Input["Input Layer"]
        BD["Beads DAG<br/>(Git-backed JSONL)"]
        API["HTTP API<br/>(:8900)"]
        CRON["Cron Scheduler<br/>(5 AM daily)"]
    end

    subgraph Engine["Temporal Execution Engine"]
        TW["Temporal Worker<br/>(cortex-task-queue)"]
        CAW["CortexAgentWorkflow"]
        PCW["PlanningCeremonyWorkflow"]
    end

    subgraph CHUM["CHUM Loop"]
        CLW["ContinuousLearnerWorkflow"]
        TGW["TacticalGroomWorkflow"]
        SGW["StrategicGroomWorkflow"]
    end

    subgraph Storage["Persistence"]
        SQL["SQLite<br/>(dispatches, outcomes)"]
        FTS["SQLite FTS5<br/>(lessons search)"]
        SEM[".semgrep/<br/>(generated rules)"]
        BRF[".beads/morning_briefing.md"]
    end

    BD --> TW
    API --> TW
    CRON --> SGW
    TW --> CAW & PCW
    CAW -->|success| CLW & TGW
    CAW --> SQL
    CLW --> FTS & SEM
    TGW --> BD
    SGW --> BRF & BD
```

---

## Workflow Topology

### CortexAgentWorkflow â€” "The Shark"

The main execution loop. Implements a LeSS/SCRUM-inspired pipeline with deterministic DoD gating.

```mermaid
stateDiagram-v2
    [*] --> Plan
    Plan --> HumanGate: Structured plan generated
    HumanGate --> Execute: APPROVED signal
    HumanGate --> Rejected: REJECTED signal
    Rejected --> [*]

    Execute --> Review: Agent output
    Review --> SemgrepFilter: Review APPROVED
    Review --> SwapAgents: Review REJECTED

    SwapAgents --> Execute: Agents swapped (â‰¤3 handoffs)

    SemgrepFilter --> DoDVerify: Semgrep PASSED
    SemgrepFilter --> Execute: Semgrep FAILED (retry with errors)

    DoDVerify --> Success: DoD PASSED
    DoDVerify --> Execute: DoD FAILED (â‰¤3 retries)
    DoDVerify --> Escalate: All retries exhausted

    Success --> SpawnCHUM: Record outcome
    SpawnCHUM --> [*]: Learner + Groom started

    Escalate --> [*]: Human notified
```

**Key design decisions:**
- **Planning is gated.** Plans without acceptance criteria are rejected before any code is written. *"Plan space is cheap, implementation is expensive."*
- **Cross-model review.** Claude reviews Codex's work, Codex reviews Claude's. This catches model-specific blind spots that self-review misses.
- **Agent swapping on rejection.** When a review fails, the reviewer becomes the implementer with the review feedback injected. Up to 3 handoffs before escalation.
- **Semgrep pre-filter.** Custom rules generated by the Learner catch known anti-patterns *before* expensive `go build`/`go test`. Free and fast.

### Cross-Model Review Handoff

```mermaid
sequenceDiagram
    participant C as Claude (Implementer)
    participant X as Codex (Reviewer)
    participant D as DoD Gate

    C->>C: Implement plan
    C->>X: Submit for review
    X->>X: Review against acceptance criteria

    alt Approved
        X-->>D: Proceed to DoD
    else Rejected
        X->>X: List issues + suggestions
        Note over C,X: SWAP: Codex becomes implementer,<br/>Claude becomes reviewer
        X->>X: Re-implement with review feedback
        X->>C: Submit for review
        C->>C: Review against criteria
    end
```

---

## CHUM â€” Continuous Hyper-Utility Module

CHUM implements a **dual-speed Kanban** system. Both speeds run as **abandoned child workflows** â€” they survive the parent completing and never block the main execution loop.

### Dual-Speed Architecture

```mermaid
graph TB
    subgraph Fast["âš¡ Event-Driven (per bead)"]
        direction TB
        CL["ContinuousLearner"]
        TG["TacticalGroom"]

        CL --> EL["ExtractLessons<br/>(fast LLM)"]
        EL --> SL["StoreLessons<br/>(SQLite FTS5)"]
        SL --> GR["GenerateSemgrepRules<br/>(enforceable lessons only)"]

        TG --> MB["MutateBeads<br/>(reprioritize, add deps, close stale)"]
    end

    subgraph Slow["ðŸ”¬ Daily Cron (5 AM)"]
        direction TB
        SG["StrategicGroom"]

        SG --> RM["GenerateRepoMap<br/>(go list + go doc)"]
        RM --> BS["GetBeadStateSummary<br/>(compressed backlog)"]
        BS --> SA["StrategicAnalysis<br/>(premium LLM)"]
        SA --> AM["ApplyMutations<br/>(capped at 5)"]
        AM --> BF["GenerateMorningBriefing<br/>(.beads/morning_briefing.md)"]
    end

    DoD["DoD PASSED"] -->|"fire-and-forget<br/>PARENT_CLOSE_POLICY_ABANDON"| CL & TG
    CRON["Cron 0 5 * * *"] --> SG
```

### The Learning Feedback Loop (LATM)

This is the **Algorithmic Crystallization** loop â€” the system converts stochastic LLM behavior into deterministic static analysis rules:

```mermaid
graph LR
    A["Agent makes mistake<br/>(DoD failures, review rejections)"] --> B["Learner extracts lesson<br/>(category: antipattern/rule)"]
    B --> C["Lesson stored in FTS5<br/>(deduplicated, searchable)"]
    C --> D["Semgrep rule generated<br/>(.semgrep/chum-*.yaml)"]
    D --> E["Next execution:<br/>Semgrep pre-filter catches it FREE"]
    E --> F["Mistake never reaches<br/>expensive DoD gate again"]
    F -.->|"Over time"| G["Factory grows its<br/>own immune system"]
```

---

## Temporal Configuration

### Task Queue

All workflows run on `cortex-task-queue`. Single shared queue simplifies deployment.

### Child Workflow Policies

| Workflow | Launch | Parent Policy | Scheduling |
|----------|--------|---------------|------------|
| `CortexAgentWorkflow` | API trigger | â€” | On-demand |
| `PlanningCeremonyWorkflow` | API trigger | â€” | On-demand |
| `ContinuousLearnerWorkflow` | Child of Shark | ABANDON | Per bead completion |
| `TacticalGroomWorkflow` | Child of Shark | ABANDON | Per bead completion |
| `StrategicGroomWorkflow` | Temporal Client | â€” | Cron `0 5 * * *` |

### Activity Timeout Design

| Activity | Timeout | Heartbeat | Retries | Rationale |
|----------|---------|-----------|---------|-----------|
| Plan | 5m | â€” | 2 | LLM generation, bounded |
| Execute | 15m | 30s | 1 | Agent coding, needs heartbeat for long runs |
| Review | 5m | â€” | 2 | LLM review, bounded |
| DoD | 5m | â€” | 1 | Compile + test, deterministic |
| Extract Lessons | 3m | â€” | 2 | Fast LLM, bounded |
| Strategic Analysis | 10m | 30s | 2 | Premium LLM, may be slow |

---

## Data Flow

### SQLite Schema (Key Tables)

```
dispatches     â€” Every agent dispatch (bead_id, agent, provider, status, duration)
dod_results    â€” DoD pass/fail per dispatch (passed, failures, coverage)
lessons        â€” Extracted lessons (category, summary, detail, file_paths, labels)
lessons_fts    â€” FTS5 virtual table for full-text lesson search
health_events  â€” System health events (escalations, gateway issues)
```

### File System Layout

```
workspace/
â”œâ”€â”€ .beads/                    # Beads DAG (issues.jsonl, deps)
â”‚   â””â”€â”€ morning_briefing.md    # StrategicGroom daily output
â”œâ”€â”€ .semgrep/                  # CHUM-generated rules
â”‚   â”œâ”€â”€ chum-nil-check-*.yaml  # Auto-generated from learner
â”‚   â””â”€â”€ chum-error-wrap-*.yaml
â””â”€â”€ .cortex/                   # Runtime state (gitignored)
    â””â”€â”€ cortex.db              # SQLite state database
```

---

## Security Model

- **No sandbox by default.** Agents run with the same permissions as the Cortex process. Sandboxing is on the [roadmap](CHUM_BACKLOG.md).
- **API binds to localhost.** No authentication on the HTTP API â€” do not expose.
- **Human gate.** Nothing enters the coding engine without explicit signal approval.
- **Semgrep enforcement.** Generated rules run before DoD, catching known-bad patterns.

---

## Live Benchmarks

> _Measured from the first production Shark execution on 2026-02-20._

### Execution: `exec-fix-broken-build` (api_test.go build fix)

| Phase | Duration | Notes |
|-------|----------|-------|
| PlanningCeremony (4 questions + summary) | 3m 31s | Interactive human-in-the-loop |
| StructuredPlan generation | ~2m 30s | LLM analyzes codebase, generates 12-step plan |
| Human gate â†’ approval | instant | Pre-approved from ceremony |
| **ExecuteActivity** | **~2m** | **Agent writes code** |
| CodeReview + Semgrep + DoD | ~1m | Cross-model review + compile/test/vet |
| CHUM spawn (Learner + Groom) | <1s | Both children started before parent completed |
| **Total: greenlight â†’ done** | **3m 14s** | **SM estimated 30-60 minutes (16x overestimate)** |

### CHUM Loop Confirmation

```
Event 45: StartChildWorkflowExecutionInitiated  â†’ Learner spawned
Event 46: StartChildWorkflowExecutionInitiated  â†’ TacticalGroom spawned
Event 47: ChildWorkflowExecutionStarted         â†’ Learner STARTED âœ“
Event 49: ChildWorkflowExecutionStarted         â†’ TacticalGroom STARTED âœ“
Event 52: WorkflowExecutionCompleted            â†’ Parent exits cleanly
```

Both abandoned children survived parent completion â€” `PARENT_CLOSE_POLICY_ABANDON` + `GetChildWorkflowExecution().Get()` pattern confirmed working in production.

### Verification

```
go build ./...  â†’ PASS
go test ./...   â†’ PASS (api package)
go vet ./...    â†’ PASS
```

