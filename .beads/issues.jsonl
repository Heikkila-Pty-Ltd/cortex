{"id":"cortex-08z","title":"Phase 1: Cortex Core — Scheduler + Rate Limiter","description":"Working Go binary that reads beads from project dirs, builds dependency graphs, finds unblocked tasks, respects unified rate limits, dispatches openclaw agents, and tracks state in SQLite. This is the core scheduling engine.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":480,"created_at":"2026-02-17T13:33:07.156580998+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:54:32.932625657+10:00","closed_at":"2026-02-17T14:54:32.932625657+10:00","close_reason":"Phase 1 complete: all 10 tasks done, binary builds and tests pass","labels":["core","phase-1"]}
{"id":"cortex-08z.1","title":"Go module init + project scaffold","description":"Initialize Go module and create the full directory structure:\n\n  go mod init github.com/antigravity-dev/cortex\n  \nCreate all package directories per module layout:\n  cmd/cortex/, internal/config/, internal/beads/, internal/scheduler/,\n  internal/dispatch/, internal/health/, internal/learner/, internal/api/, internal/store/\n\nAdd core dependencies:\n  modernc.org/sqlite (pure-Go SQLite driver)\n  github.com/BurntSushi/toml (config parsing)\n\nCreate minimal main.go with signal handling skeleton (SIGINT/SIGTERM graceful shutdown).\nCreate Makefile with build, install, clean targets.\n\nAcceptance criteria:\n- go build ./cmd/cortex/ produces a working binary\n- Binary starts and exits cleanly on SIGINT\n- All package dirs exist with placeholder .go files","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":30,"created_at":"2026-02-17T13:45:59.053458725+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:40:50.31309257+10:00","closed_at":"2026-02-17T14:40:50.31309257+10:00","close_reason":"Scaffold complete: go mod, all packages, main.go with signal handling, Makefile, deps installed, builds clean","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.1","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:45:59.057613426+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.10","title":"Main binary entry point + systemd unit","description":"Wire everything together in cmd/cortex/main.go and create the systemd service file.\n\nmain.go:\n1. Parse flags: --config (default: cortex.toml), --once (run single tick then exit, for testing)\n2. Load config via config.Load()\n3. Open store via store.Open(config.StateDB)\n4. Create rateLimiter, dispatcher, scheduler\n5. Start scheduler in goroutine\n6. Block on signal (SIGINT/SIGTERM) for graceful shutdown\n7. On shutdown: cancel context, wait for running tick to finish, close store\n\ncortex.service (systemd user unit):\n  [Unit]\n  Description=Cortex Agent Orchestrator\n  After=openclaw-gateway.service\n\n  [Service]\n  Type=simple\n  ExecStart=%h/projects/cortex/cortex --config %h/projects/cortex/cortex.toml\n  Restart=always\n  RestartSec=10\n  Environment=PATH=%h/.local/bin:/usr/local/bin:/usr/bin\n\n  [Install]\n  WantedBy=default.target\n\nMakefile targets:\n  build: go build -o cortex ./cmd/cortex/\n  install: cp cortex ~/.local/bin/\n  service-install: cp cortex.service ~/.config/systemd/user/ \u0026\u0026 systemctl --user daemon-reload\n  service-start: systemctl --user enable --now cortex.service\n\nAcceptance criteria:\n- cortex binary starts, runs one tick with --once flag, exits cleanly\n- cortex binary runs continuously and responds to SIGTERM\n- systemd unit installs and starts correctly\n- Logs appear in journalctl --user -u cortex.service","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":45,"created_at":"2026-02-17T14:12:41.806052224+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:54:32.551083368+10:00","closed_at":"2026-02-17T14:54:32.551083368+10:00","close_reason":"Main binary, systemd unit, and Makefile all implemented","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.10","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T14:12:41.809619678+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.10","depends_on_id":"cortex-08z.9","type":"blocks","created_at":"2026-02-17T14:12:41.815717384+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.2","title":"TOML config loader","description":"Implement internal/config/config.go that parses cortex.toml into typed Go structs.\n\nStructs needed:\n- Config (top-level): General, Projects map, RateLimits, Providers map, Tiers, Health, Reporter, API\n- General: TickInterval (duration), MaxPerTick (int), StuckTimeout (duration), MaxRetries (int), LogLevel (string), StateDB (path)\n- Project: Enabled (bool), BeadsDir (path), Workspace (path), Priority (int)\n- RateLimits: Window5hCap (int), WeeklyCap (int), WeeklyHeadroomPct (int)\n- Provider: Tier (string), Authed (bool), Model (string)\n- Tiers: Fast, Balanced, Premium ([]string provider names)\n- Health: CheckInterval (duration), GatewayUnit (string)\n- Reporter: Channel (string), AgentID (string), DailyDigestTime (string), WeeklyRetroDay (string)\n- API: Bind (string)\n\nValidate on load: all provider names in tiers exist in providers map, at least one project enabled, state_db dir exists.\n\nCreate the default cortex.toml with all providers and hg-website as the initial enabled project.\n\nAcceptance criteria:\n- Config loads from cortex.toml successfully\n- Invalid configs return descriptive errors\n- Unit test covers: valid config, missing required fields, unknown provider in tier","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T13:50:22.592398066+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:50.180842457+10:00","closed_at":"2026-02-17T14:48:50.180842457+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.2","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:50:22.618547657+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.2","depends_on_id":"cortex-08z.1","type":"blocks","created_at":"2026-02-17T13:50:22.636563313+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.3","title":"SQLite store layer","description":"Implement internal/store/store.go with SQLite operations.\n\nOn first run, auto-create schema:\n- dispatches table (id, bead_id, project, agent_id, provider, tier, pid, prompt, dispatched_at, completed_at, status, exit_code, duration_s, retries, escalated_from_tier)\n- provider_usage table (id, provider, agent_id, bead_id, dispatched_at)\n- health_events table (id, event_type, details, created_at)\n- tick_metrics table (id, tick_at, project, beads_open, beads_ready, dispatched, completed, failed, stuck)\n\nCRUD methods:\n- RecordDispatch(beadID, project, agent, provider, tier, pid, prompt) -\u003e id\n- UpdateDispatchStatus(id, status, exitCode, durationS)\n- GetRunningDispatches() -\u003e []Dispatch\n- GetStuckDispatches(timeout duration) -\u003e []Dispatch\n- RecordProviderUsage(provider, agentID, beadID)\n- CountAuthedUsage5h() -\u003e int\n- CountAuthedUsageWeekly() -\u003e int\n- RecordHealthEvent(eventType, details)\n- RecordTickMetrics(project, open, ready, dispatched, completed, failed, stuck)\n\nIndexes: idx_dispatches_status, idx_dispatches_bead, idx_usage_provider(provider, dispatched_at)\n\nAcceptance criteria:\n- All tables created on first Open()\n- All CRUD methods work with unit tests\n- Concurrent access safe (WAL mode enabled)\n- Database path from config.StateDB","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":90,"created_at":"2026-02-17T13:52:01.773492457+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:52:09.214755913+10:00","closed_at":"2026-02-17T14:52:09.214755913+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.3","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:52:01.785318491+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.3","depends_on_id":"cortex-08z.2","type":"blocks","created_at":"2026-02-17T13:52:01.796104448+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.4","title":"Beads CLI wrapper","description":"Implement internal/beads/beads.go that wraps the bd CLI to read bead data from project directories.\n\nFunctions:\n- ListBeads(beadsDir string) -\u003e []Bead, error\n  Runs: bd list --json --quiet in the given directory\n  Parses JSON into Bead structs\n\n- ShowBead(beadsDir, beadID string) -\u003e BeadDetail, error\n  Runs: bd show --json {beadID}\n\n- CloseBead(beadsDir, beadID string) -\u003e error\n  Runs: bd close {beadID}\n\nBead struct fields:\n  ID, Title, Description, Status, Priority, Type, Labels []string,\n  EstimateMinutes int, ParentID string, DependsOn []string,\n  Acceptance string, Design string, CreatedAt time.Time\n\nBuildDepGraph(beads []Bead) -\u003e *DepGraph\n  Builds a directed graph from DependsOn + ParentID edges.\n  \nFilterUnblockedOpen(graph *DepGraph) -\u003e []Bead\n  Returns beads that are: status=open AND all DependsOn beads are closed AND parent is open (not skipped).\n  Sorted by: Priority ASC (P0 first), then EstimateMinutes ASC.\n\nAcceptance criteria:\n- ListBeads correctly parses bd list --json output\n- DepGraph correctly identifies unblocked beads\n- Unit tests with sample JSON fixtures (no actual bd calls)\n- Handles empty bead lists gracefully","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":90,"created_at":"2026-02-17T13:52:33.664382221+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:50.205960855+10:00","closed_at":"2026-02-17T14:48:50.205960855+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.4","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:52:33.668720161+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.4","depends_on_id":"cortex-08z.1","type":"blocks","created_at":"2026-02-17T13:52:33.674972084+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.5","title":"Unified rate limiter","description":"Implement internal/dispatch/ratelimit.go with the unified authed rate limiter.\n\nCore concept: All authed subscription providers (Claude Max20, OpenAI Pro, Google Pro, Kimi) share two hard gates — a 5h rolling window cap and a weekly cap. Free-tier providers (cerebras, groq) are uncapped.\n\nFunctions:\n- NewRateLimiter(store *store.Store, cfg config.RateLimits) -\u003e *RateLimiter\n- CanDispatchAuthed() -\u003e (bool, string reason)\n  Checks both gates against store.CountAuthedUsage5h() and store.CountAuthedUsageWeekly()\n  Returns false + reason if either gate exceeded\n- RecordAuthedDispatch(provider, agentID, beadID string)\n  Delegates to store.RecordProviderUsage()\n- WeeklyUsagePct() -\u003e float64\n  Returns current weekly usage as percentage of cap\n- IsInHeadroomWarning() -\u003e bool\n  Returns true if WeeklyUsagePct \u003e= config.WeeklyHeadroomPct (default 80%)\n\nAlgorithm for provider selection within a tier:\n- PickProvider(tier string, providers []config.Provider) -\u003e *config.Provider\n  1. If tier is fast -\u003e pick from free providers (no quota check)\n  2. If tier is balanced/premium -\u003e check CanDispatchAuthed()\n  3. If authed gates pass -\u003e return first available provider in tier order\n  4. If gates fail -\u003e return nil (caller handles tier downgrade)\n\nTier downgrade logic (in scheduler, not here):\n  premium -\u003e balanced -\u003e fast, or defer to next tick\n\nAcceptance criteria:\n- 5h rolling window correctly counts dispatches in last 5 hours\n- Weekly rolling window correctly counts dispatches in last 7 days\n- Free-tier providers bypass all gates\n- Headroom warning triggers at configured percentage\n- Unit tests with seeded usage data covering: under cap, at cap, over cap, headroom warning","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T13:52:59.000042143+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:52:58.486999173+10:00","closed_at":"2026-02-17T14:52:58.486999173+10:00","close_reason":"Rate limiter implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.5","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:52:59.002997357+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.5","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T13:52:59.008672868+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.6","title":"Role inference + complexity detection","description":"Implement internal/scheduler/role.go and internal/scheduler/complexity.go.\n\nRole inference (role.go):\n- InferRole(bead Bead) -\u003e string\n  Maps bead labels/type to agent role:\n  | Bead Labels / Type | Role |\n  | Any open bead with code files listed | coder |\n  | Label contains review, test, qa | reviewer |\n  | Label contains deploy, ops, ci | ops |\n  | Type = epic | skip (Cortex tracks epic completion automatically) |\n  | Default | coder |\n  \n- ResolveAgent(project string, role string) -\u003e string\n  Returns '{project}-{role}' (e.g. 'hg-website-coder')\n  Falls back to 'main-{role}' if project-specific agent doesn't exist\n\nComplexity detection (complexity.go):\n- DetectComplexity(bead Bead) -\u003e string (tier: fast|balanced|premium)\n  | Signal | Tier |\n  | estimated_minutes \u003c= 30 | fast |\n  | estimated_minutes 31-90 | balanced |\n  | estimated_minutes \u003e 90 | premium |\n  | Label complex or architecture | premium |\n  | Label trivial or chore | fast |\n  Labels override time-based detection.\n\nAcceptance criteria:\n- Role correctly inferred from labels with priority ordering\n- Complexity correctly maps estimate + labels to tier\n- Label override takes precedence over time estimate\n- Unit tests cover all mapping combinations","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":45,"created_at":"2026-02-17T13:56:22.89995188+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:52:09.244025453+10:00","closed_at":"2026-02-17T14:52:09.244025453+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.6","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:56:22.903471817+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.6","depends_on_id":"cortex-08z.4","type":"blocks","created_at":"2026-02-17T13:56:22.908012317+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.7","title":"Agent prompt builder","description":"Implement internal/scheduler/prompt.go that constructs the prompt sent to openclaw agents.\n\nFunction:\n- BuildPrompt(bead Bead, project config.Project) -\u003e string\n\nTemplate:\n  You are working on project {project_name} in {workspace_dir}.\n\n  ## Task: {bead.title} ({bead.id})\n\n  {bead.description}\n\n  ## Acceptance Criteria\n  {bead.acceptance}\n\n  ## Design Notes\n  {bead.design}\n\n  ## Instructions\n  1. Read the acceptance criteria carefully\n  2. Implement in the files listed (create if needed)\n  3. Run tests if they exist\n  4. Commit with message: feat({bead.id}): {short_title}\n  5. When done, run: bd close {bead.id}\n  6. Push: git push\n\n  ## Context Files\n  {extracted file paths from bead description}\n\nFile extraction: scan description for paths matching common patterns (src/, internal/, *.go, *.ts, *.py, etc.)\n\nAcceptance criteria:\n- Prompt includes all bead metadata (title, description, acceptance, design)\n- File paths extracted from description\n- Template is readable and well-structured\n- Unit test verifies template rendering with sample bead","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":30,"created_at":"2026-02-17T13:56:47.58364861+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:52:09.287511394+10:00","closed_at":"2026-02-17T14:52:09.287511394+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.7","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:56:47.587726938+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.7","depends_on_id":"cortex-08z.4","type":"blocks","created_at":"2026-02-17T13:56:47.59525896+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.8","title":"OpenClaw agent dispatcher","description":"Implement internal/dispatch/dispatcher.go that wraps the openclaw CLI to dispatch agents.\n\nFunctions:\n- Dispatch(agent string, prompt string, provider string, thinkingLevel string) -\u003e (pid int, error)\n  Runs: openclaw agent --agent {agent} --message {prompt} --thinking {thinkingLevel}\n  Starts process in background, returns PID for tracking.\n  thinkingLevel derived from tier: fast=none, balanced=low, premium=high\n\n- IsProcessAlive(pid int) -\u003e bool\n  Checks if PID is still running via kill -0\n\n- KillProcess(pid int) -\u003e error\n  Sends SIGTERM, waits 5s, then SIGKILL if still alive\n\nEnvironment setup:\n  Ensure openclaw binary is in PATH\n  Set CWD to project workspace directory\n\nAcceptance criteria:\n- Dispatch starts an openclaw agent process and returns valid PID\n- IsProcessAlive correctly reports live/dead processes\n- KillProcess terminates gracefully with fallback to SIGKILL\n- Unit tests mock exec.Command for isolation\n- Integration test (manual): dispatches a real agent with a trivial prompt, confirms PID tracking","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T13:58:10.798997021+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:50.233413221+10:00","closed_at":"2026-02-17T14:48:50.233413221+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.8","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:58:10.801768094+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.8","depends_on_id":"cortex-08z.1","type":"blocks","created_at":"2026-02-17T13:58:10.857391397+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.9","title":"Core scheduler tick loop","description":"Implement internal/scheduler/scheduler.go — the main orchestration loop that ties everything together.\n\nScheduler struct holds references to: config, store, rateLimiter, dispatcher, logger.\n\nRunTick() method (called every config.TickInterval):\n1. For each enabled project (sorted by priority):\n   a. beads = ListBeads(project.BeadsDir)\n   b. graph = BuildDepGraph(beads)\n   c. ready = FilterUnblockedOpen(graph)\n   d. Record tick metrics (beads_open, beads_ready counts)\n   \n2. For each ready bead (up to maxPerTick across all projects):\n   a. Skip if alreadyDispatched (check store.GetRunningDispatches)\n   b. role = InferRole(bead) — skip if epic\n   c. tier = DetectComplexity(bead)\n   d. provider = rateLimiter.PickProvider(tier)\n   e. If provider nil: try tier downgrade (premium-\u003ebalanced-\u003efast), log if all exhausted\n   f. prompt = BuildPrompt(bead, project)\n   g. agent = ResolveAgent(project.Name, role)\n   h. pid = dispatcher.Dispatch(agent, prompt, provider, thinkingLevel)\n   i. store.RecordDispatch(bead.ID, project.Name, agent, provider, tier, pid, prompt)\n   j. rateLimiter.RecordAuthedDispatch(provider) if authed\n   \n3. CheckRunningDispatches():\n   a. For each running dispatch in store:\n   b. If PID dead -\u003e mark completed or failed based on exit code\n   c. Record duration\n\nStart() method:\n  Runs RunTick in a goroutine on a ticker, respects context cancellation for graceful shutdown.\n\nAcceptance criteria:\n- Tick loop iterates projects by priority\n- Respects maxPerTick limit across all projects\n- Skips already-dispatched beads (no double dispatch)\n- Tier downgrade works: premium-\u003ebalanced-\u003efast\n- Running dispatch status polling detects completed/failed\n- Integration test: mock all deps, verify dispatch sequence with sample beads\n- Structured logging (slog) for each dispatch decision","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":120,"created_at":"2026-02-17T14:07:02.448542707+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:53:43.738555982+10:00","closed_at":"2026-02-17T14:53:43.738555982+10:00","close_reason":"Scheduler tick loop implemented, all tests pass","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T14:07:02.453104918+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:07:02.459620762+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.4","type":"blocks","created_at":"2026-02-17T14:07:02.463452132+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.5","type":"blocks","created_at":"2026-02-17T14:07:02.467106582+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.6","type":"blocks","created_at":"2026-02-17T14:07:02.470851552+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.7","type":"blocks","created_at":"2026-02-17T14:07:02.474640783+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.8","type":"blocks","created_at":"2026-02-17T14:07:02.478246162+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-0kw","title":"Phase 5: Status API + Polish","description":"HTTP status endpoints (/status, /projects/{id}, /health, /metrics), Makefile with build/install/service-install targets, graceful shutdown, structured logging (slog), README.md with architecture overview.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":240,"created_at":"2026-02-17T13:40:32.974740877+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T15:03:00.339150723+10:00","closed_at":"2026-02-17T15:03:00.339150723+10:00","close_reason":"Closed","labels":["api","phase-5","polish"]}
{"id":"cortex-0kw.1","title":"HTTP status API","description":"Implement internal/api/api.go — lightweight HTTP API for querying Cortex state.\n\nEndpoints:\n- GET /status -\u003e overall Cortex status (uptime, last tick, dispatches running, rate limiter state)\n- GET /projects -\u003e list of enabled projects with bead counts (open, ready, running, completed)\n- GET /projects/{id} -\u003e detailed project view: recent dispatches, ready beads, velocity\n- GET /health -\u003e health check summary: gateway status, recent health events, stuck count\n- GET /metrics -\u003e Prometheus-compatible metrics: dispatches_total, dispatches_failed_total, rate_limiter_usage_ratio, tick_duration_seconds\n\nServer:\n- net/http stdlib (no framework needed for 5 endpoints)\n- Bind to config.API.Bind (default 127.0.0.1:8900)\n- JSON responses with proper Content-Type headers\n- Starts as goroutine from main.go, shutdown via context cancellation\n\nAcceptance criteria:\n- All 5 endpoints return valid JSON\n- /health returns 200 when healthy, 503 when gateway down\n- /metrics compatible with Prometheus scraping format\n- Server starts on configured bind address\n- Graceful shutdown on context cancellation\n- Unit tests for each endpoint handler with mock store data","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:25:40.41699718+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T15:01:50.741273815+10:00","closed_at":"2026-02-17T15:01:50.741273815+10:00","close_reason":"Closed","labels":["api","phase-5"],"dependencies":[{"issue_id":"cortex-0kw.1","depends_on_id":"cortex-0kw","type":"parent-child","created_at":"2026-02-17T14:25:40.443618494+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-0kw.1","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:25:40.487881873+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-0kw.1","depends_on_id":"cortex-08z.10","type":"blocks","created_at":"2026-02-17T14:25:40.506134929+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-0kw.2","title":"Structured logging with slog","description":"Replace all fmt.Printf/log.Printf calls with Go's structured logging (log/slog).\n\nSetup:\n- Configure slog in main.go based on config.LogLevel (debug/info/warn/error)\n- Use slog.With() for per-component loggers: scheduler, dispatcher, health, api, learner\n- JSON output format for machine parsing, text format for development (--dev flag)\n\nLog key events with structured fields:\n- Dispatch: bead_id, project, agent, provider, tier, pid\n- Completion: bead_id, duration_s, exit_code, status\n- Rate limit: tier, usage_5h, usage_weekly, cap_5h, cap_weekly\n- Health: event_type, details, action_taken\n- Tick: project, beads_open, beads_ready, dispatched_count\n\nAcceptance criteria:\n- All log output uses slog with structured fields\n- Log level configurable via cortex.toml\n- JSON format in production, text in dev\n- No raw fmt.Printf left in non-test code\n- Logs parseable by standard log aggregators","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":30,"created_at":"2026-02-17T14:26:00.96225876+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T15:01:50.781848424+10:00","closed_at":"2026-02-17T15:01:50.781848424+10:00","close_reason":"Closed","labels":["phase-5","polish"],"dependencies":[{"issue_id":"cortex-0kw.2","depends_on_id":"cortex-0kw","type":"parent-child","created_at":"2026-02-17T14:26:01.00291675+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-0kw.2","depends_on_id":"cortex-08z.10","type":"blocks","created_at":"2026-02-17T14:26:01.074752193+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-0kw.3","title":"Graceful shutdown + README","description":"Polish the binary for production use.\n\nGraceful shutdown (enhance main.go):\n1. On SIGTERM/SIGINT: set shutdown flag\n2. Wait for any in-progress tick to complete (don't kill mid-dispatch)\n3. Close HTTP API server with context timeout (5s)\n4. Close SQLite store cleanly\n5. Log shutdown reason and duration\n\nREADME.md:\n- Architecture overview with ASCII diagram from plan\n- Quick start: build, configure cortex.toml, install systemd unit, start\n- Configuration reference: all cortex.toml sections with defaults\n- Provider setup: how to add/remove providers\n- Project setup: how to enable a new project (beads dir, workspace, agent creation)\n- Monitoring: how to query the HTTP API, where logs go\n- Troubleshooting: common issues (gateway down, rate limit hit, stuck tasks)\n\nAcceptance criteria:\n- Binary handles shutdown cleanly in all states (idle, mid-tick, mid-dispatch)\n- README covers all sections listed above\n- README is accurate to the actual implementation\n- No orphan processes left on shutdown","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":45,"created_at":"2026-02-17T14:26:28.456959192+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T15:03:00.120347648+10:00","closed_at":"2026-02-17T15:03:00.120347648+10:00","close_reason":"Closed","labels":["phase-5","polish"],"dependencies":[{"issue_id":"cortex-0kw.3","depends_on_id":"cortex-0kw","type":"parent-child","created_at":"2026-02-17T14:26:28.712913955+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-0kw.3","depends_on_id":"cortex-0kw.1","type":"blocks","created_at":"2026-02-17T14:26:28.73566296+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-0kw.3","depends_on_id":"cortex-0kw.2","type":"blocks","created_at":"2026-02-17T14:26:28.741505263+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-80e","title":"Phase 3: Self-Propelling Pipeline","description":"Multi-dispatch per tick (up to max_per_tick=3), auto-advance stuck stage labels, pipeline flush when downstream has 0 tasks but upstream completed, immediate child-unblock detection on bd close.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":240,"created_at":"2026-02-17T13:38:38.32962461+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:56:18.952234779+10:00","closed_at":"2026-02-17T14:56:18.952234779+10:00","close_reason":"Phase 3 complete","labels":["phase-3","pipeline"]}
{"id":"cortex-80e.1","title":"Multi-dispatch per tick","description":"Enhance the scheduler tick loop to dispatch up to max_per_tick (default 3) agents per tick across all projects, rather than just 1.\n\nChanges to scheduler.go RunTick():\n1. Collect all ready beads across all enabled projects into a single priority-sorted queue\n2. Dispatch up to max_per_tick from that merged queue\n3. Respect per-project ordering (higher priority project's beads sort first)\n4. If rate limiter blocks authed dispatch, still try free-tier beads from the queue\n5. Log: 'Dispatched {n}/{max} this tick, {remaining} ready beads queued'\n\nAlso add configurable per-project max_concurrent (default: 2) to prevent one project hogging all slots.\n\nAcceptance criteria:\n- Multiple agents dispatched in single tick when beads available\n- Per-project concurrent limit respected\n- Free-tier dispatches not blocked by authed rate limit exhaustion\n- Integration test with multiple projects and beads verifies dispatch ordering","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:21:03.114718461+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:56:18.675554601+10:00","closed_at":"2026-02-17T14:56:18.675554601+10:00","close_reason":"Pipeline features implemented","labels":["phase-3","pipeline"],"dependencies":[{"issue_id":"cortex-80e.1","depends_on_id":"cortex-80e","type":"parent-child","created_at":"2026-02-17T14:21:03.286932177+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-80e.1","depends_on_id":"cortex-08z.9","type":"blocks","created_at":"2026-02-17T14:21:03.352634985+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-80e.2","title":"Immediate child-unblock detection","description":"When a dispatch completes (detected during CheckRunningDispatches), immediately check if any of the completed bead's children/dependents are now unblocked, rather than waiting for the next tick.\n\nChanges:\n1. After marking a dispatch as completed in CheckRunningDispatches():\n   a. Get the bead ID that was just closed\n   b. Re-run ListBeads + BuildDepGraph for that project\n   c. Filter newly unblocked beads (beads whose last blocking dep was the just-completed bead)\n   d. If any newly unblocked AND within max_per_tick budget: dispatch immediately\n2. Log: 'Bead {id} completed, {n} children now unblocked, dispatching {m}'\n\nThis creates a reactive chain: as agents close beads, Cortex immediately picks up the next work without waiting 60s.\n\nAcceptance criteria:\n- Completing a bead triggers immediate check for newly unblocked children\n- Newly unblocked beads dispatched within same tick cycle\n- Still respects rate limits and max_per_tick\n- Does not re-dispatch already-running beads\n- Unit test: complete parent bead, verify child gets dispatched","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":45,"created_at":"2026-02-17T14:22:23.894750453+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:56:18.706061805+10:00","closed_at":"2026-02-17T14:56:18.706061805+10:00","close_reason":"Pipeline features implemented","labels":["phase-3","pipeline"],"dependencies":[{"issue_id":"cortex-80e.2","depends_on_id":"cortex-80e","type":"parent-child","created_at":"2026-02-17T14:22:23.946003135+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-80e.2","depends_on_id":"cortex-08z.9","type":"blocks","created_at":"2026-02-17T14:22:23.988987021+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-80e.3","title":"Pipeline flush for stalled downstreams","description":"Detect when a project's downstream beads have 0 open tasks but upstream beads have been completed, indicating the pipeline has stalled at a stage transition.\n\nLogic:\n1. After each tick, for each project:\n   a. Group beads by epic/parent\n   b. If an epic has all children closed -\u003e auto-close the epic via bd close\n   c. If all beads in a dependency chain are closed but the chain's root epic is still open -\u003e close it\n2. This prevents epics from staying open forever when all their children are done.\n\nAlso handle stage label advancement:\n- If a bead has label 'ready' and gets dispatched -\u003e could optionally update label to 'in-progress' via bd CLI\n- On completion -\u003e label updated to 'done' (or just bd close handles this)\n\nAcceptance criteria:\n- Epics auto-closed when all children are closed\n- No false positives (don't close epics with open children)\n- Handles nested epics (epic with child epics)\n- Unit test with sample bead graphs verifying auto-close logic","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":45,"created_at":"2026-02-17T14:22:41.309838405+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:56:18.726626735+10:00","closed_at":"2026-02-17T14:56:18.726626735+10:00","close_reason":"Pipeline features implemented","labels":["phase-3","pipeline"],"dependencies":[{"issue_id":"cortex-80e.3","depends_on_id":"cortex-80e","type":"parent-child","created_at":"2026-02-17T14:22:41.335299436+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-80e.3","depends_on_id":"cortex-08z.4","type":"blocks","created_at":"2026-02-17T14:22:41.356206295+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-80e.3","depends_on_id":"cortex-08z.9","type":"blocks","created_at":"2026-02-17T14:22:41.368733091+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-88b","title":"Phase 0: Cleanup \u0026 Archive Legacy Orchestration","description":"Archive all redundant orchestration tooling that Cortex replaces. Move to ~/backups/orchestration-legacy/. Disable old systemd services.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":30,"created_at":"2026-02-17T13:32:56.868558981+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:51.439494801+10:00","closed_at":"2026-02-17T14:48:51.439494801+10:00","close_reason":"Phase 0 complete","labels":["cleanup","phase-0"]}
{"id":"cortex-88b.1","title":"Archive redundant repos and scripts","description":"Create ~/backups/orchestration-legacy/ directory. Move: ~/orchestration/ (nearly empty), ~/gateway-monitor/ (redundant simple health script), ~/projects/command-center/ (FastAPI dashboard, replaced by Cortex API), select clawd scripts (auditor-check.sh, pane-babysitter.sh, flywheel-monitor.sh), clawd prompts (commander.md, coo-agent.md, project-auditor.md). Write ~/backups/orchestration-legacy/README.md documenting what was archived and why.\n\nAcceptance criteria:\n- All listed dirs/files moved to backup location\n- README.md describes each archived item\n- No broken symlinks left behind\n- Original locations cleaned up","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":15,"created_at":"2026-02-17T13:40:48.238110194+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:50.527087372+10:00","closed_at":"2026-02-17T14:48:50.527087372+10:00","close_reason":"Legacy dirs archived, services disabled","labels":["cleanup","phase-0"],"dependencies":[{"issue_id":"cortex-88b.1","depends_on_id":"cortex-88b","type":"parent-child","created_at":"2026-02-17T13:40:48.2410416+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-88b.2","title":"Disable legacy systemd services","description":"Stop and disable the old orchestration services that Cortex replaces:\n- openclaw-workflow.service (heartbeat orchestrator)\n- openclaw-workflow.timer (5-min trigger)\n\nCommands:\n  systemctl --user stop openclaw-workflow.timer openclaw-workflow.service\n  systemctl --user disable openclaw-workflow.timer openclaw-workflow.service\n\nAcceptance criteria:\n- Both services stopped and disabled\n- systemctl --user list-timers shows no openclaw-workflow entry\n- Gateway service (openclaw-gateway.service) remains running (Cortex uses it)","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":10,"created_at":"2026-02-17T13:41:23.335249561+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:50.591854037+10:00","closed_at":"2026-02-17T14:48:50.591854037+10:00","close_reason":"Legacy dirs archived, services disabled","labels":["cleanup","phase-0"],"dependencies":[{"issue_id":"cortex-88b.2","depends_on_id":"cortex-88b","type":"parent-child","created_at":"2026-02-17T13:41:23.340020989+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-a4s","title":"Scrum master as project point-of-contact via Matrix","description":"Make the scrum master agent the human-facing communication interface for each project, communicating bidirectionally via Matrix.\n\nCurrently the scrum master silently refines tasks, and the Reporter sends generic digests through a 'main' agent. These are disconnected. The scrum master should OWN the communication loop for its project:\n\n**Outbound (scrum master → human):**\n- Progress reports: what completed, what's in flight, what's blocked\n- Blocker alerts: dependencies stuck, agents failing, rate limits hit\n- Decision requests: ambiguous tasks needing human judgment\n- Stage transition summaries: 'task X moved to review, agent Y picked it up'\n\n**Inbound (human → scrum master):**\n- Priority changes: 'drop everything, focus on X'\n- Task creation: 'add a bug for the login issue'\n- Status queries: 'what's the status of feature Y?'\n- Guidance: 'use approach A not B for auth'\n\n**Key design:**\n- Each project gets its own Matrix room (or thread)\n- The scrum master agent is the only one that talks to humans\n- Other agents (coder, reviewer, ops) report TO the scrum master, not directly to Matrix\n- Reporter refactored to delegate to scrum masters rather than dispatching directly\n- Inbound messages are polled/received and routed to the correct project's scrum master\n\nThis turns Cortex from a silent automation engine into something you can actually talk to per-project.","status":"open","priority":1,"issue_type":"epic","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:19:10.509970488+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:19:10.509970488+10:00"}
{"id":"cortex-a4s.1","title":"Add per-project Matrix room config","description":"Extend cortex.toml and config parser to support per-project Matrix room routing.\n\nCurrent config only has a global [reporter] section with a single channel and agent_id. Need per-project Matrix targeting so each scrum master talks in its own room.\n\nConfig changes:\n```toml\n[projects.hg-website]\nenabled = true\nbeads_dir = \"~/projects/hg-website/.beads\"\nworkspace = \"~/projects/hg-website\"\npriority = 1\nmatrix_room = \"!abc123:matrix.org\"   # NEW: project-specific room\n```\n\nAlso support a default room in [reporter] as fallback:\n```toml\n[reporter]\nchannel = \"matrix\"\nagent_id = \"main\"\ndefault_room = \"!general:matrix.org\"  # fallback if project has no room\n```\n\nChanges to internal/config/config.go:\n- Add MatrixRoom string to Project struct\n- Add DefaultRoom string to Reporter struct\n- Validation: warn (not error) if project has no matrix_room and no default_room\n- Helper: ResolveRoom(project) returns project room or default\n\nAcceptance: Config parses with and without matrix_room, ResolveRoom works, backward compatible","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:20:38.878902601+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:20:38.878902601+10:00","dependencies":[{"issue_id":"cortex-a4s.1","depends_on_id":"cortex-a4s","type":"parent-child","created_at":"2026-02-17T17:20:38.89009374+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-a4s.10","title":"Split scrum master dispatches by tier: Opus for planning, cheap for reporting","description":"The scrum master handles both complex cognitive work (planning, refinement, decisions) and simple mechanical work (status reports, notifications). These should use different tiers.\n\n**Current problem:**\nDetectComplexity() assigns tier based on bead labels/estimate. The scrum master's tier is determined by the bead it's working on, not the function it's performing. A sprint planning pass and a status ping both go through the same tier selection. Wasteful.\n\n**Tier split by scrum master function:**\n\nPremium (Claude Opus):\n- Sprint planning (reviewing full backlog, making prioritization decisions)\n- Backlog refinement (adding acceptance criteria, design notes)\n- Inbound command handling (parsing human intent, deciding actions)\n- Decision requests (identifying ambiguity, framing options)\n\nFast/Balanced (free or cheap models):\n- Daily standup reports (templated, data-driven)\n- Stage transition notifications (mechanical: 'X moved to review')\n- Blocker alerts (templated: 'X is stuck because Y')\n- Status query responses (read beads, summarize)\n- Completion summaries (mechanical: 'X closed, N files changed')\n\n**Implementation:**\n\nAdd a dispatch purpose/function concept:\n\n```go\n// internal/scheduler/purpose.go\ntype DispatchPurpose string\n\nconst (\n    PurposeSprintPlanning  DispatchPurpose = \"sprint_planning\"\n    PurposeRefinement      DispatchPurpose = \"refinement\"\n    PurposeInboundCommand  DispatchPurpose = \"inbound_command\"\n    PurposeDecisionRequest DispatchPurpose = \"decision_request\"\n    PurposeStandup         DispatchPurpose = \"standup\"\n    PurposeNotification    DispatchPurpose = \"notification\"\n    PurposeStatusQuery     DispatchPurpose = \"status_query\"\n)\n\n// TierForPurpose returns the appropriate tier for a dispatch purpose.\nfunc TierForPurpose(purpose DispatchPurpose) string {\n    switch purpose {\n    case PurposeSprintPlanning, PurposeRefinement,\n         PurposeInboundCommand, PurposeDecisionRequest:\n        return \"premium\"\n    case PurposeStandup, PurposeNotification,\n         PurposeStatusQuery:\n        return \"fast\"\n    default:\n        return \"balanced\"\n    }\n}\n```\n\nConfig override (optional, let users tune):\n```toml\n[scrum_tiers]\nsprint_planning = \"premium\"\nrefinement = \"premium\"\ninbound_command = \"premium\"\ndecision_request = \"premium\"\nstandup = \"fast\"\nnotification = \"fast\"\nstatus_query = \"fast\"\n```\n\n**Integration points:**\n- SprintPlanner.RunPlanning() passes PurposeSprintPlanning → tier=premium\n- Reporter/Notifier passes PurposeNotification → tier=fast\n- InboundProcessor.HandleMessage() passes PurposeInboundCommand → tier=premium\n- Standup report passes PurposeStandup → tier=fast\n- TierForPurpose() replaces DetectComplexity() for scrum master dispatches\n- Other roles (coder, reviewer, ops) continue using DetectComplexity() as before\n\n**Provider config:**\nAdd Opus to premium tier in cortex.toml:\n```toml\n[providers.opus]\ntier = \"premium\"\nauthed = true\nmodel = \"claude-opus-4-6\"\n```\n\nAcceptance:\n- Sprint planning and refinement dispatch through premium tier (Opus)\n- Status/notification dispatches use fast tier (free models)\n- Config allows overriding tier per purpose\n- Other roles unaffected\n- Rate limit impact minimized (most scrum master work is cheap)","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:29:51.383490329+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:29:51.383490329+10:00","dependencies":[{"issue_id":"cortex-a4s.10","depends_on_id":"cortex-a4s","type":"parent-child","created_at":"2026-02-17T17:29:51.38850478+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.10","depends_on_id":"cortex-a4s.9","type":"blocks","created_at":"2026-02-17T17:29:57.797438226+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.10","depends_on_id":"cortex-a4s.4","type":"blocks","created_at":"2026-02-17T17:29:57.932871392+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.10","depends_on_id":"cortex-a4s.8","type":"blocks","created_at":"2026-02-17T17:29:58.10315621+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-a4s.11","title":"Implement scrum master sprint review and retrospective","description":"Add a sprint review + retrospective ceremony where the scrum master analyzes what happened, what failed, what was learned, and what to change.\n\n**Current state:**\n- retro.go generates raw stats: dispatch counts, provider failure rates, tier accuracy, misclassification %\n- outcomes.go has velocity, provider stats queries\n- FormatRetroMarkdown() outputs a data table\n- Nobody reasons about the data. It's numbers without narrative.\n\n**What's needed — two related processes:**\n\n### 1. Sprint Review (end of sprint / weekly)\nWhat was planned vs what was delivered.\n\nData fed to scrum master:\n- Beads selected in last sprint planning (from RecordSprintPlanning)\n- Which were completed, which are still open, which failed\n- Completion rate: N/M planned beads done\n- Unplanned work: beads completed that weren't in the sprint plan\n- Scope creep: beads added mid-sprint\n- Velocity trend: this sprint vs last 3 sprints\n\nScrum master (Opus tier) produces:\n- Narrative summary of what shipped\n- Highlight any beads that were planned but not delivered, with why\n- Note unplanned work that displaced planned work\n- Velocity assessment: accelerating, stable, or slowing\n- Sent to Matrix\n\n### 2. Sprint Retrospective (end of sprint / weekly, after review)\nWhat went well, what went wrong, what to change.\n\nData fed to scrum master:\n- Full RetroReport from retro.go (provider stats, tier accuracy)\n- Failed dispatches with details: which beads, which providers, what tier, how many retries\n- Stuck dispatches: what timed out, was escalation effective\n- Tier misclassifications: fast tasks that took premium-level time, premium tasks that were trivial\n- Health events: gateway restarts, zombie cleanups\n- Agent performance: which agents (coder/reviewer/ops) completed fastest, which struggled\n- Rate limit usage: did we hit caps, how close\n\nScrum master (Opus tier) analyzes and produces:\n- **What went well**: patterns in successful dispatches, effective provider/tier combos\n- **What went wrong**: failure patterns, recurring issues, wasted capacity\n- **Learnings**: 'Provider X fails on Go tasks but succeeds on frontend', 'Tier misclassification is high for tasks with no estimate — we should require estimates in sprint planning'\n- **Action items**: concrete changes to make\n  - Config changes: 'deprioritize provider X', 'adjust complexity thresholds'\n  - Process changes: 'require estimates before stage:ready', 'add gate for linting'\n  - Beads to create: 'file a bug for the recurring test flake in project Y'\n- Scrum master can actually EXECUTE simple action items (update config, create beads)\n\n### Implementation:\n\nCreate internal/learner/ceremonies.go:\n\ntype SprintCeremony struct {\n    store      *store.Store\n    dispatcher *dispatch.Dispatcher\n    cfg        *config.Config\n    logger     *slog.Logger\n}\n\nfunc (sc *SprintCeremony) RunReview(ctx, project):\n1. Gather sprint review data (planned vs delivered)\n2. Build ProjectContext\n3. Dispatch to scrum master with review prompt (premium tier)\n4. Scrum master outputs narrative to Matrix\n\nfunc (sc *SprintCeremony) RunRetro(ctx, project):\n1. Generate RetroReport via GenerateWeeklyRetro()\n2. Query failed/stuck dispatches with details\n3. Get health events for the sprint period\n4. Build comprehensive analysis prompt with all data\n5. Dispatch to scrum master with retro prompt (premium tier)\n6. Scrum master outputs learnings + action items to Matrix\n\n### Scheduling:\nConfig:\n```toml\n[projects.hg-website]\nsprint_review_day = \"Friday\"\nsprint_review_time = \"16:00\"\nsprint_retro_day = \"Friday\"     # runs after review\nsprint_retro_time = \"17:00\"\n```\n\nOr derive from existing weekly_retro_day in [reporter].\n\n### Store additions:\n- GetFailedDispatchDetails(project, window) → []FailedDispatch with bead title, provider, tier, error context, retry count\n- GetStuckDispatchDetails(project, window) → []StuckDispatch with timeout duration, escalation history\n- GetAgentPerformance(project, window) → map[agent]AgentStats (completed, failed, avg duration)\n\n### Prompt templates:\nAdd 'sprint_review' and 'sprint_retro' to stageInstructions in prompt.go. These are the longest, most detailed prompts — they give the scrum master all the raw data and ask it to reason about patterns.\n\n### Tier:\nBoth ceremonies use premium tier (Opus) — this is analytical reasoning work.\n\n### Relationship to existing code:\n- retro.go: keep as data layer, ceremonies.go calls it\n- outcomes.go: keep as data layer, extend with new queries\n- reporter.go: ceremonies dispatch through scrum master, not through reporter directly\n\nAcceptance:\n- Sprint review compares planned vs delivered, produces narrative\n- Sprint retro analyzes failures/learnings, produces action items\n- Both dispatched through scrum master at premium tier\n- Data comes from existing retro.go + new detail queries\n- Sent to Matrix via scrum master agent\n- Scrum master can create follow-up beads from action items\n- Scheduled weekly, configurable day/time","status":"open","priority":1,"issue_type":"feature","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:32:27.739648447+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:32:27.739648447+10:00","dependencies":[{"issue_id":"cortex-a4s.11","depends_on_id":"cortex-a4s","type":"parent-child","created_at":"2026-02-17T17:32:27.745043106+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.11","depends_on_id":"cortex-a4s.2","type":"blocks","created_at":"2026-02-17T17:32:37.285776045+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.11","depends_on_id":"cortex-a4s.3","type":"blocks","created_at":"2026-02-17T17:32:37.519704868+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.11","depends_on_id":"cortex-a4s.9","type":"blocks","created_at":"2026-02-17T17:32:37.698330207+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.11","depends_on_id":"cortex-a4s.7","type":"blocks","created_at":"2026-02-17T17:32:37.832795531+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-a4s.2","title":"Give scrum master project state context","description":"Build a project state summarizer that gives the scrum master rich context about its project before it communicates.\n\nCurrently when a scrum master agent is dispatched, it only sees the single bead it's refining. To be a useful point of contact, it needs the full picture.\n\nCreate internal/scheduler/context.go with:\n\ntype ProjectContext struct {\n    Project       string\n    OpenBeads     int\n    InProgress    int\n    Blocked       int\n    CompletedToday int\n    FailedToday   int\n    RunningAgents []RunningAgent  // currently dispatched\n    RecentCompletions []string    // last 5 completed bead titles\n    BlockerSummary    []string    // what's blocked and why\n    Velocity          float64     // beads/day rolling 7d\n}\n\ntype RunningAgent struct {\n    Agent    string\n    BeadID   string\n    BeadTitle string\n    Role     string\n    Duration time.Duration\n}\n\nfunc BuildProjectContext(store, project) ProjectContext:\n- Query store for dispatch stats\n- Query beads for open/blocked/in-progress counts\n- Calculate velocity from GetProjectVelocity\n- List running dispatches with durations\n\nfunc FormatContextForPrompt(ctx ProjectContext) string:\n- Render as markdown section that gets prepended to scrum master prompts\n- Concise but complete: '3 open, 1 blocked (X depends on Y), 2 agents running'\n\nAcceptance: Context builds from store data, formats cleanly, tested","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:20:50.868998306+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:20:50.868998306+10:00","dependencies":[{"issue_id":"cortex-a4s.2","depends_on_id":"cortex-a4s","type":"parent-child","created_at":"2026-02-17T17:20:50.871928723+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-a4s.3","title":"Refactor Reporter to route through scrum master agents","description":"Change the Reporter to dispatch messages through each project's scrum master agent instead of the generic 'main' agent.\n\nCurrent flow (internal/learner/reporter.go):\n  Reporter.dispatchMessage() → dispatcher.Dispatch(cfg.AgentID='main', message)\n\nNew flow:\n  Reporter.SendProjectDigest(project) → dispatcher.Dispatch(project+'-scrum', message)\n  Reporter.SendProjectAlert(project, type, msg) → dispatcher.Dispatch(project+'-scrum', message)\n\nKey changes:\n- SendDigest becomes SendDigests (iterates projects, sends per-project digest)\n- Each digest goes through that project's scrum master agent\n- The scrum master agent's system prompt (ROLE.md) already positions it as the communicator\n- Include ProjectContext in the digest prompt so scrum master has full picture\n- The scrum master then formats and sends to Matrix (its agent config points at the project's room)\n\nFallback: if project has no scrum master agent, fall back to generic 'main' agent\n\nRemove the old single-message-blast pattern. Each project gets its own tailored communication.\n\nAcceptance: Digests route through scrum master, per-project context included, fallback works","status":"open","priority":1,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:20:55.978000565+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:20:55.978000565+10:00","dependencies":[{"issue_id":"cortex-a4s.3","depends_on_id":"cortex-a4s","type":"parent-child","created_at":"2026-02-17T17:20:55.980979041+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.3","depends_on_id":"cortex-a4s.1","type":"blocks","created_at":"2026-02-17T17:21:57.093685141+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.3","depends_on_id":"cortex-a4s.2","type":"blocks","created_at":"2026-02-17T17:21:57.290914978+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-a4s.4","title":"Implement scrum master outbound notifications","description":"Add event-driven outbound notifications from the scrum master to Matrix, beyond just daily digests.\n\nNotification types (internal/scheduler/notify.go or similar):\n\n1. **Blocker Alert**: When a bead becomes blocked or an agent fails\n   - Trigger: dispatch fails, stuck timeout hit, rate limit exhausted\n   - Message: 'Task X is blocked: agent failed after 30m, escalating to premium tier'\n\n2. **Stage Transition**: When a bead moves between stages\n   - Trigger: stage label changes detected during bead discovery\n   - Message: 'Task X moved to review (was: coding). Agent hg-website-reviewer picking it up next tick.'\n\n3. **Decision Request**: When scrum master identifies ambiguity during refinement\n   - Trigger: scrum master's refinement output contains a decision flag\n   - Message: 'Task X needs clarification: should we use REST or GraphQL for the new endpoint?'\n\n4. **Completion Summary**: When a bead is closed\n   - Trigger: bead status changes to closed\n   - Message: 'Task X completed by hg-website-coder. 3 files changed, tests passing.'\n\n5. **Capacity Warning**: When rate limits approach headroom\n   - Trigger: WeeklyUsagePct \u003e headroom threshold\n   - Message: 'Rate limit at 85%. 30 dispatches remaining this week. Prioritize carefully.'\n\nImplementation:\n- Create a Notifier that the scheduler calls at appropriate points in RunTick\n- Notifier routes through the project's scrum master agent\n- Dedup logic (don't spam same alert within 1h, already exists in Reporter)\n- Notification preferences per project (optional, can be added later)\n\nAcceptance: All 5 notification types fire at correct triggers, routed through scrum master, deduped","status":"open","priority":1,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:21:04.804924868+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:21:04.804924868+10:00","dependencies":[{"issue_id":"cortex-a4s.4","depends_on_id":"cortex-a4s","type":"parent-child","created_at":"2026-02-17T17:21:04.810369436+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.4","depends_on_id":"cortex-a4s.2","type":"blocks","created_at":"2026-02-17T17:22:01.301398933+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.4","depends_on_id":"cortex-a4s.3","type":"blocks","created_at":"2026-02-17T17:22:01.47223537+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-a4s.5","title":"Implement Matrix inbound message polling","description":"Add the ability for Cortex to receive inbound messages from humans via Matrix and route them to the correct project's scrum master.\n\nThis is the hardest piece — making communication bidirectional.\n\nCreate internal/matrix/poller.go:\n\nApproach: Poll Matrix room(s) for new messages using the Matrix client-server API.\n\ntype Poller struct {\n    homeserver string\n    token      string\n    rooms      map[string]string // room_id → project name\n    since      string           // sync token for incremental polling\n    interval   time.Duration\n    handler    InboundHandler\n}\n\ntype InboundMessage struct {\n    Project   string\n    Room      string\n    Sender    string\n    Body      string\n    Timestamp time.Time\n    EventID   string\n}\n\ntype InboundHandler interface {\n    HandleMessage(ctx context.Context, msg InboundMessage) error\n}\n\nFlow:\n1. Poller runs on interval (e.g. 30s)\n2. Calls Matrix /sync endpoint with since token\n3. Filters for m.room.message events in tracked rooms\n4. Ignores messages from our own bot user\n5. Maps room → project\n6. Calls handler.HandleMessage() for each new message\n\nConfig additions to [reporter] or new [matrix] section:\n```toml\n[matrix]\nhomeserver = \"https://matrix.org\"\ntoken_env = \"CORTEX_MATRIX_TOKEN\"  # read from env var, never in config\npoll_interval = \"30s\"\nbot_user = \"@cortex-bot:matrix.org\"\n```\n\nSecurity: token read from env var only. Never stored in config file.\n\nAcceptance: Poller connects to Matrix, receives messages, routes to correct project, handles reconnection","status":"open","priority":1,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:21:14.181085879+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:21:14.181085879+10:00","dependencies":[{"issue_id":"cortex-a4s.5","depends_on_id":"cortex-a4s","type":"parent-child","created_at":"2026-02-17T17:21:14.187008568+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.5","depends_on_id":"cortex-a4s.1","type":"blocks","created_at":"2026-02-17T17:22:04.609786866+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-a4s.6","title":"Implement scrum master inbound command handling","description":"When the scrum master receives an inbound human message via Matrix, it needs to understand and act on it.\n\nCreate internal/scheduler/inbound.go:\n\ntype InboundProcessor struct {\n    store      *store.Store\n    dispatcher *dispatch.Dispatcher\n    projects   map[string]config.Project\n}\n\nfunc (p *InboundProcessor) HandleMessage(ctx, msg InboundMessage) error:\n1. Dispatch to the project's scrum master agent with:\n   - The human's message\n   - Current ProjectContext\n   - Instructions to parse intent and take action\n2. The scrum master agent determines what to do:\n   - **Status query** → respond with project state summary\n   - **Priority change** → run bd update to reprioritize\n   - **Task creation** → run bd create with details\n   - **Guidance** → update relevant bead's design notes\n   - **Other** → acknowledge and note for next standup\n3. Scrum master's response goes back to the Matrix room\n\nThe scrum master agent handles the NLU — we don't need to parse commands ourselves. The agent's ROLE.md should be updated to include:\n- 'When you receive a human message, determine the intent and take the appropriate action'\n- 'Always respond in the Matrix room with what you did'\n- 'For status queries, use bd list and bd show to gather current state'\n\nUpdate ROLE.md in internal/team/team.go to add communication responsibilities.\n\nAcceptance: Human messages dispatched to scrum master, scrum master responds with actions, response sent back to Matrix","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:21:24.490363129+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:21:24.490363129+10:00","dependencies":[{"issue_id":"cortex-a4s.6","depends_on_id":"cortex-a4s","type":"parent-child","created_at":"2026-02-17T17:21:24.501960084+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.6","depends_on_id":"cortex-a4s.5","type":"blocks","created_at":"2026-02-17T17:22:08.708436386+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.6","depends_on_id":"cortex-a4s.2","type":"blocks","created_at":"2026-02-17T17:22:09.089043739+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.6","depends_on_id":"cortex-a4s.7","type":"blocks","created_at":"2026-02-17T17:22:09.293367704+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-a4s.7","title":"Update scrum master ROLE.md for communication responsibilities","description":"Update the scrum master agent's role description in internal/team/team.go to reflect its new position as the project's point of contact.\n\nCurrent ROLE.md focuses only on task refinement. Expand to cover:\n\n```markdown\n# Scrum Master Agent\n\nYou are the scrum master and primary point of contact for this project.\n\n## Communication (Primary)\n- You are the ONLY agent that communicates with humans\n- Report progress, blockers, and decisions via Matrix\n- When you receive a human message, determine intent and act:\n  - Status queries: gather state with bd list/show, summarize\n  - Priority changes: reprioritize with bd update\n  - Task creation: create beads with bd create\n  - Guidance: update design notes on relevant beads\n  - Always confirm what you did\n\n## Daily Standup\n- Summarize: what completed yesterday, what's in progress, any blockers\n- Flag beads that have been in_progress for \u003e24h\n- Highlight rate limit status if above 70%\n\n## Task Refinement\n- Review descriptions for clarity and completeness\n- Add or improve acceptance criteria\n- Break large tasks into sub-tasks\n- Estimate effort when missing\n\n## Stage Workflow\n- You receive tasks at stage:backlog\n- When refinement is complete, transition to stage:planning\n- Always unassign yourself after transitioning\n```\n\nAlso update EnsureTeam() to re-write ROLE.md if it detects the old version (or add a version marker).\n\nAcceptance: New ROLE.md covers communication, standup, and refinement. Agent behaves as point of contact.","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:21:36.630347088+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:21:36.630347088+10:00","dependencies":[{"issue_id":"cortex-a4s.7","depends_on_id":"cortex-a4s","type":"parent-child","created_at":"2026-02-17T17:21:36.639118512+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-a4s.8","title":"Implement scrum master daily standup report","description":"Replace the generic daily digest with a scrum-master-authored standup report per project.\n\nCurrent digest (Reporter.SendDigest) is a simple template:\n  '## Daily Cortex Digest — {date}\n   - project: N beads completed today\n   - Health: N events'\n\nNew standup (dispatched through scrum master agent):\nThe scrum master receives ProjectContext and produces a standup-style report:\n\n**Yesterday:**\n- Completed: list of closed beads with brief outcomes\n- Failed: any beads that failed with reasons\n\n**Today:**\n- In Progress: what's currently being worked, by which agent\n- Ready: what's unblocked and queued for dispatch\n- Blocked: what's stuck and on what\n\n**Risks:**\n- Rate limit status (usage/cap)\n- Stuck dispatches or repeated failures\n- Beads in_progress for \u003e24h\n\nThe scrum master formats this conversationally, not as raw data. It should feel like a team standup message in a chat room.\n\nSchedule: runs at daily_digest_time from config (default 09:00).\nReplaces Reporter.SendDigest() calls — the standup IS the digest.\n\nAcceptance: Standup generates per-project, routed through scrum master, includes all sections, conversational tone","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:21:48.097683349+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:21:48.097683349+10:00","dependencies":[{"issue_id":"cortex-a4s.8","depends_on_id":"cortex-a4s","type":"parent-child","created_at":"2026-02-17T17:21:48.101256464+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.8","depends_on_id":"cortex-a4s.3","type":"blocks","created_at":"2026-02-17T17:22:13.485440432+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.8","depends_on_id":"cortex-a4s.2","type":"blocks","created_at":"2026-02-17T17:22:13.651877467+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-a4s.9","title":"Implement scrum master sprint planning function","description":"Add a sprint planning mode where the scrum master reviews the entire backlog holistically, refines beads in bulk, and selects a sprint's worth of work.\n\n**Current problem:**\nThe scrum master is dispatched per-bead (one stage:backlog bead → one dispatch). It never sees the full picture. It can't prioritize across beads, spot duplicates, identify missing work, or decide what goes into the next sprint. It's a bead-refiner, not a planner.\n\n**Sprint planning function:**\n\nTrigger: scheduled (e.g. weekly, configurable) OR when backlog exceeds threshold (e.g. \u003e5 unrefined beads) OR manual trigger via Matrix.\n\nConfig:\n```toml\n[projects.hg-website]\nsprint_planning_day = \"Monday\"        # weekly trigger\nsprint_planning_time = \"08:00\"\nsprint_capacity = 10                   # max beads per sprint\nbacklog_threshold = 5                  # auto-trigger if unrefined backlog exceeds this\n```\n\nCreate internal/scheduler/sprint.go:\n\ntype SprintPlanner struct {\n    store      *store.Store\n    dispatcher *dispatch.Dispatcher\n    cfg        *config.Config\n    logger     *slog.Logger\n}\n\nfunc (sp *SprintPlanner) RunPlanning(ctx, project, projectCfg):\n\n1. **Gather backlog**: List all beads that are open + have no stage label or stage:backlog\n2. **Build context**: Include already-in-progress work, recently closed beads, dependency graph\n3. **Dispatch scrum master with full backlog**:\n   - Send ALL backlog beads to the scrum master in a single dispatch (not one-by-one)\n   - Prompt includes every backlog bead's title, description, current priority, estimate, labels\n   - Also includes the dependency graph so scrum master can see what unblocks what\n4. **Scrum master instructions** (sprint planning prompt template):\n   - Review each backlog bead for clarity and completeness\n   - Add acceptance criteria where missing (bd update \u003cid\u003e --acceptance=\"...\")\n   - Add design notes with implementation approach (bd update \u003cid\u003e --design=\"...\")\n   - Set or adjust estimates (bd update \u003cid\u003e --estimate=\u003cminutes\u003e)\n   - Set or adjust priority based on business value + dependencies\n   - Break down any bead estimated \u003e120min into sub-tasks\n   - Identify and flag duplicate or overlapping beads\n   - Select top N beads (up to sprint_capacity) and transition them: bd update \u003cid\u003e --labels stage:planning\n   - Leave remaining beads in backlog with notes on why deferred\n   - Output a sprint plan summary at the end\n\n5. **Sprint plan summary** (sent to Matrix via scrum master):\n   - What's in the sprint (selected beads with priorities)\n   - What was deferred and why\n   - Any blockers or risks identified\n   - Estimated sprint capacity usage\n\n**New prompt template** in internal/scheduler/prompt.go:\nAdd a 'sprint_planning' key to stageInstructions that includes the full backlog context and planning instructions above.\n\n**Scheduler integration**:\n- Add a sprint planning check to RunTick or as a separate goroutine\n- Check: is it sprint_planning_day + sprint_planning_time? → trigger\n- Check: count of stage:backlog beads \u003e backlog_threshold? → trigger\n- Dedup: don't re-trigger if planning ran within last 24h (track in store)\n\n**Store additions**:\n- RecordSprintPlanning(project, beadsSelected, beadsDeferred, timestamp)\n- GetLastSprintPlanning(project) → timestamp (for dedup)\n\nAcceptance:\n- Sprint planning dispatches scrum master with full backlog context\n- Scrum master refines, estimates, and selects beads in one pass\n- Sprint plan summary sent to Matrix\n- Triggers work (scheduled + threshold + manual)\n- Config is backward compatible (no sprint planning = old behavior)","status":"open","priority":1,"issue_type":"feature","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:26:38.982883997+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:26:38.982883997+10:00","dependencies":[{"issue_id":"cortex-a4s.9","depends_on_id":"cortex-a4s","type":"parent-child","created_at":"2026-02-17T17:26:39.003463728+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.9","depends_on_id":"cortex-a4s.2","type":"blocks","created_at":"2026-02-17T17:26:43.470607057+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-a4s.9","depends_on_id":"cortex-a4s.7","type":"blocks","created_at":"2026-02-17T17:26:43.657625009+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-ceg","title":"Plan pluggable dispatch: headless CLI vs tmux vs openclaw by task complexity","description":"Plan the dispatcher abstraction to support multiple backends based on task characteristics.\n\n## Context\n- Current dispatch is tightly coupled to openclaw agent CLI (~5 lines in dispatch.go)\n- OpenClaw gateway serves comms and planning, not just agent dispatch — that value must be preserved or replaced\n- Headless CLIs (claude, codex, kimi, kilocode) can handle coding tasks directly without a gateway\n- tmux gives observability and session persistence for longer/complex work\n\n## Key Design Questions\n\n### 1. Task routing by complexity/length\n- **Fast tier (≤30min, trivial/chore)**: headless CLI is ideal — fire and forget, low overhead\n- **Balanced tier (31-90min)**: headless CLI or tmux? At what duration does observability matter?\n- **Premium tier (\u003e90min, complex/architecture)**: tmux likely better — attach to watch, survives crashes, can interact if stuck\n- Should routing be tier-based, estimate-based, or label-based?\n\n### 2. When tmux vs headless\n- tmux adds: observability (attach to watch), crash resilience (session persists), ability to interact\n- tmux costs: session management complexity, cleanup of dead sessions, port/name collisions\n- headless adds: simplicity, easy PID tracking (already implemented), lower overhead\n- Decision: what's the threshold? 60min? 'complex' label? premium tier only?\n\n### 3. OpenClaw gateway role\n- Gateway currently handles comms (Matrix?) and planning/coordination between agents\n- If we move coding dispatch to headless CLIs, gateway still needed for:\n  - Inter-agent communication\n  - Task planning and decomposition\n  - Status reporting\n  - Any shared context/memory between agents\n- Need to map which gateway functions are essential vs replaceable\n\n### 4. Pluggable dispatcher interface\n- Abstract dispatch behind a Go interface: Dispatch(ctx, prompt, workDir, opts) -\u003e (handle, err)\n- Backends: headless-cli, tmux, openclaw (keep as option)\n- Config in cortex.toml per-provider or per-tier\n- Process tracking: PID for headless, session name for tmux, PID for openclaw\n\n### 5. Provider mapping\n- Which headless CLIs map to which providers?\n  - claude CLI -\u003e claude-max20 (and free tier via different model flag)\n  - codex CLI -\u003e openai-pro\n  - kimi CLI -\u003e kimi\n  - kilocode -\u003e ?\n- How do thinking levels translate per CLI?\n\n## Deliverable\nArchitecture decision doc + implementation plan for the dispatcher refactor.","status":"in_progress","priority":2,"issue_type":"feature","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:09:32.66414023+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:10:18.61998916+10:00"}
{"id":"cortex-f4n","title":"Phase 4: Self-Improving + Reporter","description":"Outcome detection (poll bd list for closed beads), duration tracking, weekly retro analysis of dispatches table, tier mismatch flagging, provider weight adjustment. Daily digest and event-driven alerts via Matrix through openclaw agent.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":240,"created_at":"2026-02-17T13:40:10.459102604+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:59:27.332196582+10:00","closed_at":"2026-02-17T14:59:27.332196582+10:00","close_reason":"Closed","labels":["learner","phase-4","reporter"]}
{"id":"cortex-f4n.1","title":"Outcome tracking + duration logging","description":"Implement internal/learner/outcomes.go — tracks task completion outcomes for learning.\n\nFunctions:\n- RecordOutcome(dispatch Dispatch, bead Bead) -\u003e error\n  Called when a dispatch transitions to completed or failed.\n  Records: bead_id, tier used, provider used, duration_s, exit_code, retries needed, escalated_from_tier.\n  \n- GetProviderStats(window time.Duration) -\u003e map[string]ProviderStats\n  Aggregates per-provider: total dispatches, avg duration, success rate, failure rate.\n  \n- GetTierAccuracy(window time.Duration) -\u003e map[string]TierAccuracy\n  Compares assigned tier vs actual duration:\n  - If a 'fast' tier task took \u003e90min -\u003e tier was underestimated\n  - If a 'premium' tier task took \u003c30min -\u003e tier was overestimated\n  Returns misclassification rate per tier.\n\n- GetProjectVelocity(project string, window time.Duration) -\u003e ProjectVelocity\n  Beads completed, avg time per bead, throughput (beads/day).\n\nAll data sourced from the dispatches table in store.\n\nAcceptance criteria:\n- Outcomes recorded on every dispatch completion\n- Provider stats accurately reflect success/failure rates\n- Tier accuracy detects misclassifications\n- Project velocity calculated correctly\n- Unit tests with seeded dispatch data","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:22:59.384589683+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:59:23.196454397+10:00","closed_at":"2026-02-17T14:59:23.196454397+10:00","close_reason":"Closed","labels":["learner","phase-4"],"dependencies":[{"issue_id":"cortex-f4n.1","depends_on_id":"cortex-f4n","type":"parent-child","created_at":"2026-02-17T14:22:59.405866381+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-f4n.1","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:22:59.427225835+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-f4n.2","title":"Weekly retrospective analysis","description":"Implement internal/learner/retro.go — generates a weekly retrospective report analyzing Cortex's performance.\n\nFunction:\n- GenerateWeeklyRetro() -\u003e RetroReport\n  Analyzes the past 7 days of dispatches data:\n  \n  1. Summary stats: total dispatches, completed, failed, stuck, avg duration\n  2. Provider performance: per-provider success rate, avg duration, failure modes\n  3. Tier accuracy: how often was the tier classification correct vs actual duration\n     - Underestimates (fast task took premium time) -\u003e suggest label adjustment\n     - Overestimates (premium task was trivial) -\u003e suggest downgrade\n  4. Project velocity: beads/day per project, backlog burn rate, ETA to empty\n  5. Rate limiter utilization: peak 5h window usage, weekly usage, headroom triggers\n  6. Recommendations: auto-generated suggestions like:\n     - 'Provider X had 40% failure rate — consider deprioritizing'\n     - 'Tier fast is overloaded — raise threshold to 45min'\n     - 'Project Y stalled — 0 beads completed in 3 days'\n\n- FormatRetroMarkdown(report RetroReport) -\u003e string\n  Formats the report as a clean markdown message suitable for Matrix delivery.\n\nScheduled: runs on config.Reporter.WeeklyRetroDay (default: Monday).\n\nAcceptance criteria:\n- Retro covers all 5 analysis dimensions\n- Recommendations are actionable and specific\n- Markdown output is clean and readable\n- Unit tests with seeded week of dispatch data\n- Handles edge case: no dispatches in the past week","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:24:18.47563934+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:59:23.214396431+10:00","closed_at":"2026-02-17T14:59:23.214396431+10:00","close_reason":"Closed","labels":["learner","phase-4"],"dependencies":[{"issue_id":"cortex-f4n.2","depends_on_id":"cortex-f4n","type":"parent-child","created_at":"2026-02-17T14:24:18.494227535+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-f4n.2","depends_on_id":"cortex-f4n.1","type":"blocks","created_at":"2026-02-17T14:24:18.649189004+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-f4n.3","title":"Daily digest + event-driven Matrix alerts","description":"Implement Matrix integration for Cortex reporting via openclaw agent dispatch.\n\nDaily digest (scheduled at config.Reporter.DailyDigestTime, default 09:00 AEST):\n- Dispatches the 'main' agent with a formatted status message:\n  ## Daily Cortex Digest — {date}\n  - **{project}:** {completed} beads completed, {ready} ready, {running} in progress\n  - **Providers:** {provider} {used}/{cap} for each authed provider\n  - **Health:** {events_count} events, {restarts} restarts\n  - **Next up:** {top_3_ready_beads}\n\n- Command: openclaw agent --agent main --message {digest} --deliver --reply-channel matrix --reply-to {room_id}\n\nEvent-driven alerts (immediate, not scheduled):\nCortex sends immediate alerts for:\n1. Task failed after max retries -\u003e includes bead ID, error details, retry history\n2. Gateway down for \u003e5min -\u003e includes restart attempts, last error\n3. Provider weekly quota \u003e80% -\u003e includes current usage, projected depletion\n\nImplementation:\n- internal/reporter/reporter.go with Reporter struct\n- SendDigest() method for daily digest\n- SendAlert(alertType, message) for event-driven alerts\n- Both use dispatcher.Dispatch to send via openclaw agent\n\nAcceptance criteria:\n- Daily digest sent at configured time with accurate stats\n- Event alerts sent immediately on trigger conditions\n- Messages formatted as readable markdown\n- Does not send duplicate alerts for same event within 1h (dedup)\n- Unit tests verify message formatting and dedup logic","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:25:20.620008341+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:59:23.233750686+10:00","closed_at":"2026-02-17T14:59:23.233750686+10:00","close_reason":"Closed","labels":["phase-4","reporter"],"dependencies":[{"issue_id":"cortex-f4n.3","depends_on_id":"cortex-f4n","type":"parent-child","created_at":"2026-02-17T14:25:20.645509375+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-f4n.3","depends_on_id":"cortex-08z.8","type":"blocks","created_at":"2026-02-17T14:25:20.725842446+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-f4n.3","depends_on_id":"cortex-f4n.1","type":"blocks","created_at":"2026-02-17T14:25:20.80543788+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-pg5","title":"Multi-workflow support: stage-based pipelines for dev, content, trading","description":"Replace single-shot dispatch with multi-stage workflow pipelines. Each workflow defines ordered stages with stage-specific roles, prompt templates, transition rules, and validation gates. A bead progresses through stages (each stage = a separate dispatch) rather than being handled in one shot.\n\nTarget workflows:\n- **Dev**: implement → test → review → merge/deploy\n- **Content**: research → draft → edit/review → publish\n- **Trading**: signal analysis → risk validation → execution → confirmation/audit\n\nKey capabilities:\n- Workflow definitions in cortex.toml config\n- Workflow engine tracking stage progression per bead\n- Stage-aware prompt building with per-stage templates\n- New roles beyond coder/reviewer/ops (writer, editor, analyst, executor, etc.)\n- DB schema extension for stage tracking (current stage, stage history, stage outputs)\n- Automatic workflow assignment based on bead labels/type\n- Gates between stages (e.g., tests must pass before review stage)\n- Manual override to skip/repeat stages\n\nThis is the largest architectural change since initial orchestrator implementation.","status":"open","priority":1,"issue_type":"epic","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:05:13.440994334+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:05:13.440994334+10:00"}
{"id":"cortex-pg5.1","title":"Define workflow data model and config schema","description":"Design and implement the core data structures for workflows.\n\nA Workflow definition needs:\n- Name (string identifier, e.g. 'dev', 'content', 'trading')\n- Stages: ordered list of Stage definitions\n- Default: bool (is this the fallback workflow?)\n- Match rules: labels/types that auto-assign this workflow\n\nA Stage definition needs:\n- Name (e.g. 'implement', 'test', 'review')\n- Role (agent role for this stage, e.g. 'coder', 'reviewer', 'writer')\n- Tier override (optional, force a specific complexity tier)\n- Prompt template key (which prompt template to use)\n- Gate (optional validation command that must succeed before advancing)\n- Auto-advance (bool: advance automatically on completion, or wait?)\n\nConfig schema in cortex.toml:\n```toml\n[workflows.dev]\ndefault = true\nmatch_labels = [\"dev\", \"code\", \"feature\", \"bug\"]\nmatch_types = [\"task\", \"bug\", \"feature\"]\n\n[[workflows.dev.stages]]\nname = \"implement\"\nrole = \"coder\"\nprompt_template = \"implement\"\n\n[[workflows.dev.stages]]\nname = \"test\"\nrole = \"reviewer\"\nprompt_template = \"test\"\ngate = \"go test ./...\"\n\n[[workflows.dev.stages]]\nname = \"review\"\nrole = \"reviewer\"\nprompt_template = \"review\"\ntier = \"premium\"\n```\n\nCreate Go types in internal/workflow/types.go\n\nAcceptance: Types compile, config can be parsed from TOML, unit test for parsing","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:06:34.87931377+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:06:34.87931377+10:00","dependencies":[{"issue_id":"cortex-pg5.1","depends_on_id":"cortex-pg5","type":"parent-child","created_at":"2026-02-17T17:06:34.929296003+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-pg5.10","title":"Add comprehensive tests for workflow system","description":"Write tests for the entire workflow system.\n\nTest files:\n- internal/workflow/types_test.go - config parsing, validation\n- internal/workflow/engine_test.go - stage progression, gate handling, completion\n- internal/workflow/prompts_test.go - template rendering per stage\n- internal/workflow/builtin_test.go - built-in workflow correctness\n- internal/store/store_test.go - new stage tracking methods\n- internal/scheduler/scheduler_test.go - workflow-integrated tick\n\nKey test scenarios:\n- Bead progresses through all stages of dev workflow\n- Gate failure prevents stage advancement\n- Bead with no matching workflow uses single-shot mode\n- Config override replaces built-in workflow\n- Stage tier override is respected\n- Concurrent beads at different stages\n- Backward compat: no workflows config = old behavior\n\nAcceptance: All tests pass, \u003e80% coverage on workflow package","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:07:33.605339669+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:07:33.605339669+10:00","labels":["test"],"dependencies":[{"issue_id":"cortex-pg5.10","depends_on_id":"cortex-pg5","type":"parent-child","created_at":"2026-02-17T17:07:33.762863647+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.10","depends_on_id":"cortex-pg5.1","type":"blocks","created_at":"2026-02-17T17:12:49.005518011+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.10","depends_on_id":"cortex-pg5.2","type":"blocks","created_at":"2026-02-17T17:12:49.184559794+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.10","depends_on_id":"cortex-pg5.3","type":"blocks","created_at":"2026-02-17T17:12:49.3910256+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.10","depends_on_id":"cortex-pg5.4","type":"blocks","created_at":"2026-02-17T17:12:49.549064945+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.10","depends_on_id":"cortex-pg5.5","type":"blocks","created_at":"2026-02-17T17:12:49.695756234+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.10","depends_on_id":"cortex-pg5.6","type":"blocks","created_at":"2026-02-17T17:12:49.857952152+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.10","depends_on_id":"cortex-pg5.7","type":"blocks","created_at":"2026-02-17T17:12:50.019518985+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.10","depends_on_id":"cortex-pg5.8","type":"blocks","created_at":"2026-02-17T17:12:50.220371225+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.10","depends_on_id":"cortex-pg5.9","type":"blocks","created_at":"2026-02-17T17:12:50.366381872+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-pg5.2","title":"Extend config parser for workflow definitions","description":"Update internal/config/config.go to parse [workflows.*] sections from cortex.toml.\n\n- Add WorkflowConfig and StageConfig structs to Config\n- Parse match_labels, match_types, stages array\n- Validate: at least one workflow if workflows section exists\n- Validate: each stage has name and role\n- Validate: no duplicate stage names within a workflow\n- Validate: referenced roles are known\n- Backward compatible: if no [workflows] section, system works as before (single-shot)\n\nAcceptance: Config parsing works with and without workflows section, validation catches malformed configs","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:06:39.043856508+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:06:39.043856508+10:00","dependencies":[{"issue_id":"cortex-pg5.2","depends_on_id":"cortex-pg5","type":"parent-child","created_at":"2026-02-17T17:06:39.060093324+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.2","depends_on_id":"cortex-pg5.1","type":"blocks","created_at":"2026-02-17T17:12:23.303038929+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-pg5.3","title":"Extend DB schema for workflow stage tracking","description":"Add workflow stage tracking to the SQLite store (internal/store/store.go).\n\nNew table: bead_stages\n- id (auto PK)\n- bead_id (string)\n- project (string)\n- workflow (string, workflow name)\n- current_stage (string, stage name)\n- stage_index (int, 0-based position in workflow)\n- total_stages (int)\n- stage_history (JSON array of {stage, status, started_at, completed_at, dispatch_id})\n- created_at, updated_at\n\nNew methods:\n- InitBeadWorkflow(beadID, project, workflow, stages) - create tracking record\n- GetBeadStage(beadID) - current stage info\n- AdvanceStage(beadID) - move to next stage\n- RecordStageCompletion(beadID, stage, dispatchID) - log stage done\n- GetBeadsAtStage(project, stage) - query by stage\n- IsWorkflowComplete(beadID) - all stages done?\n\nUpdate dispatches table: add 'workflow' and 'stage' columns (nullable for backward compat).\n\nAcceptance: Schema migrates cleanly, methods work, existing data unaffected","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:06:44.122181075+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:06:44.122181075+10:00","dependencies":[{"issue_id":"cortex-pg5.3","depends_on_id":"cortex-pg5","type":"parent-child","created_at":"2026-02-17T17:06:44.157824257+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-pg5.4","title":"Implement workflow engine for stage progression","description":"Create internal/workflow/engine.go - the core workflow engine that drives beads through stages.\n\nEngine responsibilities:\n- AssignWorkflow(bead) → workflow name: match bead labels/type against workflow match rules, fall back to default workflow, return 'single-shot' if no workflows configured\n- GetCurrentStage(bead) → stage definition: look up where bead is in its workflow\n- ShouldDispatch(bead, stage) → bool: check if stage needs a new dispatch (not already running)\n- RunGate(bead, stage) → (passed bool, output string): execute gate command if defined\n- Advance(bead) → (nextStage, done): move to next stage or mark workflow complete\n- HandleStageCompletion(bead, dispatch) → action: when a dispatch completes, decide next action (run gate → advance or fail)\n\nThe engine sits between the scheduler and dispatcher. The scheduler calls the engine to determine what to dispatch next for each bead.\n\nKey design: the engine is stateless - all state lives in the DB (bead_stages table). Engine reads state, computes action, writes state.\n\nAcceptance: Engine correctly progresses beads through multi-stage workflows, handles gate failures, integrates with store","status":"open","priority":1,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:06:49.78662763+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:06:49.78662763+10:00","dependencies":[{"issue_id":"cortex-pg5.4","depends_on_id":"cortex-pg5","type":"parent-child","created_at":"2026-02-17T17:06:49.807644349+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.4","depends_on_id":"cortex-pg5.1","type":"blocks","created_at":"2026-02-17T17:12:23.527139002+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.4","depends_on_id":"cortex-pg5.2","type":"blocks","created_at":"2026-02-17T17:12:39.725638067+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.4","depends_on_id":"cortex-pg5.3","type":"blocks","created_at":"2026-02-17T17:12:39.924255356+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-pg5.5","title":"Add stage-aware prompt templates","description":"Extend internal/scheduler/prompt.go to support per-stage prompt templates.\n\nCurrent BuildPrompt() creates a single generic prompt. Need multiple templates:\n\nTemplates (internal/workflow/prompts.go):\n- 'implement': Current default prompt (implement the task)\n- 'test': Focus on writing/running tests for already-implemented code\n- 'review': Review code changes, check for bugs/style/security, suggest fixes\n- 'draft': Write content based on brief/outline (for content workflow)\n- 'edit': Edit/improve existing content for clarity and quality\n- 'publish': Format and prepare content for publication\n- 'analyze': Analyze data/signals and produce structured findings\n- 'validate': Check analysis against risk rules, flag concerns\n- 'execute': Execute a validated action with audit trail\n\nEach template receives the same context (bead info, workspace, acceptance criteria) but frames the task differently.\n\nBuildPrompt signature changes: BuildPrompt(bead, workspace, stage) where stage determines template selection.\n\nAlso include stage context in prompt: 'You are at stage 2/4 (test) of the dev workflow. Previous stage (implement) was completed by agent X.'\n\nAcceptance: Prompts render correctly per stage, backward compatible when no workflow","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:06:54.983770899+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:06:54.983770899+10:00","dependencies":[{"issue_id":"cortex-pg5.5","depends_on_id":"cortex-pg5","type":"parent-child","created_at":"2026-02-17T17:06:55.015798901+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.5","depends_on_id":"cortex-pg5.1","type":"blocks","created_at":"2026-02-17T17:12:23.758666929+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-pg5.6","title":"Extend role system for workflow-specific roles","description":"Extend internal/scheduler/role.go to support workflow-defined roles.\n\nCurrent roles: coder, reviewer, ops (inferred from labels).\n\nNew roles needed:\n- writer (content drafting)\n- editor (content editing/review)\n- publisher (content publishing)\n- analyst (data/signal analysis)\n- risk (risk validation)\n- executor (action execution)\n- auditor (confirmation/audit)\n\nChanges:\n- When a workflow stage specifies a role, use that role directly (no inference needed)\n- Keep InferRole() as fallback for single-shot mode (no workflow)\n- Agent naming: {project}-{role} remains the pattern\n- Add ValidateRole() to check role is known\n\nAcceptance: Workflow-specified roles override inferred roles, agent names resolve correctly","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:06:59.541458505+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:06:59.541458505+10:00","dependencies":[{"issue_id":"cortex-pg5.6","depends_on_id":"cortex-pg5","type":"parent-child","created_at":"2026-02-17T17:06:59.570084549+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.6","depends_on_id":"cortex-pg5.1","type":"blocks","created_at":"2026-02-17T17:12:23.9932262+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-pg5.7","title":"Update scheduler to drive workflow stages","description":"Modify internal/scheduler/scheduler.go RunTick to integrate the workflow engine.\n\nCurrent flow: discover beads → infer role/complexity → pick provider → dispatch\nNew flow: discover beads → assign workflow → get current stage → check gates → infer complexity (or use stage override) → pick provider → dispatch stage\n\nKey changes to RunTick:\n1. After filtering unblocked beads, call engine.AssignWorkflow() for each\n2. For workflow beads: call engine.GetCurrentStage() instead of InferRole()\n3. Use stage.Role for agent resolution (not label-inferred role)\n4. Use stage.Tier override if set, else DetectComplexity() as before\n5. Pass stage to BuildPrompt()\n6. On dispatch completion detection: call engine.HandleStageCompletion()\n   - If gate passes → engine.Advance() → next tick dispatches next stage\n   - If gate fails → mark stage failed, retry or escalate\n7. A bead is only closed (bd close) when IsWorkflowComplete() returns true\n8. Single-shot beads (no workflow match) continue working exactly as before\n\nAcceptance: Multi-stage beads progress through workflow, single-shot beads unaffected, gates enforced","status":"open","priority":1,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:07:06.913146127+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:07:06.913146127+10:00","dependencies":[{"issue_id":"cortex-pg5.7","depends_on_id":"cortex-pg5","type":"parent-child","created_at":"2026-02-17T17:07:07.012047961+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.7","depends_on_id":"cortex-pg5.4","type":"blocks","created_at":"2026-02-17T17:12:40.096220052+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.7","depends_on_id":"cortex-pg5.5","type":"blocks","created_at":"2026-02-17T17:12:40.313278826+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.7","depends_on_id":"cortex-pg5.6","type":"blocks","created_at":"2026-02-17T17:12:40.616978352+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.7","depends_on_id":"cortex-pg5.8","type":"blocks","created_at":"2026-02-17T17:12:40.828620379+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-pg5.8","title":"Add built-in workflow templates: dev, content, trading","description":"Create three built-in workflow definitions that ship with Cortex.\n\nFile: internal/workflow/builtin.go\n\n**Dev Workflow** (default=true):\n- match_labels: dev, code, feature, bug, refactor\n- match_types: task, bug, feature\n- Stages:\n  1. implement (coder) - write the code\n  2. test (reviewer, gate: 'go test ./...') - verify with tests\n  3. review (reviewer, tier: premium) - code review\n\n**Content Workflow**:\n- match_labels: content, blog, docs, copy, writing\n- match_types: docs\n- Stages:\n  1. research (analyst) - gather context and outline\n  2. draft (writer) - write first draft\n  3. edit (editor) - review and polish\n  4. publish (publisher) - format and ship\n\n**Trading Workflow**:\n- match_labels: trade, signal, execution, position\n- Stages:\n  1. analyze (analyst, tier: premium) - analyze signal/opportunity\n  2. validate (risk) - risk check and sizing\n  3. execute (executor) - place the trade\n  4. confirm (auditor) - verify execution and log\n\nBuilt-ins are used when no [workflows] config exists. If config defines workflows, they override built-ins. Provide a MergeWithBuiltins() function that lets config extend rather than replace.\n\nAcceptance: Built-in workflows available out of box, overridable via config","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:07:17.704634701+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:07:17.704634701+10:00","dependencies":[{"issue_id":"cortex-pg5.8","depends_on_id":"cortex-pg5","type":"parent-child","created_at":"2026-02-17T17:07:17.751369399+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.8","depends_on_id":"cortex-pg5.1","type":"blocks","created_at":"2026-02-17T17:12:24.197539381+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-pg5.9","title":"Add workflow status API endpoints","description":"Extend internal/api/api.go with workflow-related endpoints.\n\nNew endpoints:\n- GET /workflows - list all defined workflows with their stages\n- GET /workflows/{name} - detail view of a workflow definition\n- GET /beads/{id}/workflow - current workflow state for a bead (stage, history, progress)\n- GET /projects/{id}/pipeline - all beads grouped by their current workflow stage\n\nUpdate existing endpoints:\n- GET /status - add workflow_beads_in_progress count, beads_by_stage breakdown\n- GET /metrics - add cortex_workflow_stage_duration_seconds histogram, cortex_workflow_completions_total counter\n\nAcceptance: Endpoints return correct data, backward compatible (empty/null when no workflows)","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:07:25.439383905+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:07:25.439383905+10:00","dependencies":[{"issue_id":"cortex-pg5.9","depends_on_id":"cortex-pg5","type":"parent-child","created_at":"2026-02-17T17:07:25.480979113+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-pg5.9","depends_on_id":"cortex-pg5.7","type":"blocks","created_at":"2026-02-17T17:12:40.990799346+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-sfb","title":"Stage-based pipeline + auto-spawn teams","description":"Implement stage-based role inference, stage-aware prompts, agent-busy guard, stage dispatch, auto-spawn teams, and /teams API endpoint","status":"closed","priority":1,"issue_type":"feature","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:10:58.547732864+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:14:48.403083372+10:00","closed_at":"2026-02-17T17:14:48.403083372+10:00","close_reason":"Implemented stage-based pipeline with auto-spawn teams"}
{"id":"cortex-tyl","title":"Phase 2: Health \u0026 Self-Healing","description":"Gateway monitoring, stuck task detection with tier escalation, zombie process cleanup, flock mutex for single-instance enforcement. Runs as separate goroutine on 2min interval.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":240,"created_at":"2026-02-17T13:37:53.458300888+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:55:46.340134573+10:00","closed_at":"2026-02-17T14:55:46.340134573+10:00","close_reason":"Phase 2 complete","labels":["health","phase-2"]}
{"id":"cortex-tyl.1","title":"Gateway health monitor","description":"Implement internal/health/health.go — monitors the OpenClaw gateway service.\n\nFunction:\n- CheckGateway(unitName string) -\u003e HealthStatus\n  1. Run: systemctl --user is-active {unitName}\n  2. If inactive -\u003e attempt restart: systemctl --user restart {unitName}\n  3. If restart fails -\u003e check for stale locks/PIDs in /tmp/openclaw-gateway*, clear them, retry\n  4. Record health event to store (gateway_restart type)\n  5. Track restart count in rolling 1h window\n  6. If 3+ restarts in 1h -\u003e return critical status (triggers Matrix alert upstream)\n\nRuns as separate goroutine on config.Health.CheckInterval (default 2min).\n\nAcceptance criteria:\n- Detects inactive gateway and restarts it\n- Clears stale lock files on restart failure\n- Records all health events to SQLite\n- Escalates to alert after 3 restarts in 1h\n- Unit tests mock systemctl commands","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:13:05.776280397+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:55:46.02130734+10:00","closed_at":"2026-02-17T14:55:46.02130734+10:00","close_reason":"Phase 2 health modules implemented with tests","labels":["health","phase-2"],"dependencies":[{"issue_id":"cortex-tyl.1","depends_on_id":"cortex-tyl","type":"parent-child","created_at":"2026-02-17T14:13:05.780322968+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.1","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:13:05.786912944+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-tyl.2","title":"Stuck task detection + tier escalation","description":"Implement internal/health/stuck.go — detects dispatched tasks that have been running too long and handles retries with tier escalation.\n\nFunction:\n- CheckStuckDispatches(timeout duration, maxRetries int) -\u003e []StuckAction\n  1. Query store.GetStuckDispatches(timeout) — dispatches WHERE status=running AND dispatched_at \u003c now()-timeout\n  2. For each stuck dispatch:\n     a. Check if PID is still alive (kill -0 pid)\n     b. If PID dead -\u003e mark status=failed in store\n     c. If PID alive but past timeout -\u003e kill it (SIGTERM, wait 5s, SIGKILL)\n     d. If retries \u003c maxRetries: re-dispatch with escalated tier (fast-\u003ebalanced-\u003epremium)\n        Set escalated_from_tier on new dispatch record\n     e. If retries \u003e= maxRetries -\u003e mark status=failed, log, return alert action\n  3. Record health events for each action taken\n\nAcceptance criteria:\n- Correctly identifies stuck dispatches past timeout\n- Dead PIDs detected and cleaned up\n- Alive-but-stuck PIDs killed gracefully\n- Tier escalation works: fast-\u003ebalanced-\u003epremium\n- Stops retrying after maxRetries, flags for alert\n- Unit tests with mock PID checks and store data","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:19:24.632167247+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:55:46.044554518+10:00","closed_at":"2026-02-17T14:55:46.044554518+10:00","close_reason":"Phase 2 health modules implemented with tests","labels":["health","phase-2"],"dependencies":[{"issue_id":"cortex-tyl.2","depends_on_id":"cortex-tyl","type":"parent-child","created_at":"2026-02-17T14:19:24.646193963+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.2","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:19:24.70179185+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.2","depends_on_id":"cortex-08z.8","type":"blocks","created_at":"2026-02-17T14:19:24.724537621+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-tyl.3","title":"Zombie process cleanup","description":"Implement internal/health/zombie.go — finds orphaned openclaw agent processes that have no matching dispatch record.\n\nFunction:\n- CleanZombies() -\u003e int (count killed)\n  1. Run: pgrep -f 'openclaw agent' to get all PIDs running openclaw agents\n  2. Query store.GetRunningDispatches() to get all tracked PIDs\n  3. Any PID from pgrep NOT in the dispatches table is an orphan\n  4. Kill orphans: SIGTERM, wait 5s, SIGKILL if still alive\n  5. Record health event for each zombie killed (zombie_killed type)\n  6. Return count of killed processes\n\nCalled from the health check goroutine on each interval.\n\nAcceptance criteria:\n- Correctly identifies orphan processes (PID exists but no dispatch record)\n- Does NOT kill processes that are tracked in dispatches\n- Graceful kill with SIGTERM fallback to SIGKILL\n- Records health events for audit trail\n- Unit tests with mock pgrep output and store data","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":30,"created_at":"2026-02-17T14:20:27.342833336+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:55:46.083012475+10:00","closed_at":"2026-02-17T14:55:46.083012475+10:00","close_reason":"Phase 2 health modules implemented with tests","labels":["health","phase-2"],"dependencies":[{"issue_id":"cortex-tyl.3","depends_on_id":"cortex-tyl","type":"parent-child","created_at":"2026-02-17T14:20:27.385269769+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.3","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:20:27.430397688+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.3","depends_on_id":"cortex-08z.8","type":"blocks","created_at":"2026-02-17T14:20:27.496748999+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-tyl.4","title":"Single-instance flock mutex","description":"Add flock-based mutex to cmd/cortex/main.go so only one Cortex instance can run at a time.\n\nOn startup:\n1. Open lock file at /tmp/cortex.lock (or config-specified path)\n2. Attempt flock(LOCK_EX | LOCK_NB)\n3. If lock fails -\u003e log 'Another Cortex instance is running', exit 1\n4. Hold lock for lifetime of process (released on exit)\n\nUse syscall.Flock in Go.\n\nAcceptance criteria:\n- Second instance exits immediately with clear error message\n- Lock released cleanly on normal exit and SIGTERM\n- Unit test: start two instances, verify second fails","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":15,"created_at":"2026-02-17T14:20:43.885573502+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:55:46.101392206+10:00","closed_at":"2026-02-17T14:55:46.101392206+10:00","close_reason":"Phase 2 health modules implemented with tests","labels":["health","phase-2"],"dependencies":[{"issue_id":"cortex-tyl.4","depends_on_id":"cortex-tyl","type":"parent-child","created_at":"2026-02-17T14:20:43.902052012+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.4","depends_on_id":"cortex-08z.10","type":"blocks","created_at":"2026-02-17T14:20:43.922396179+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-xhk","title":"LeSS coordination layer: cross-team orchestration","description":"Implement the Large-Scale Scrum (LeSS) coordination layer for multi-project orchestration.\n\nCurrently each project is a silo — its own beads, its own agents, its own scrum master, no awareness of other projects. This epic adds the cross-team coordination that LeSS requires: a Chief Scrum Master, cross-project dependencies, aligned cadence, shared learnings, unified ceremonies, and capacity budgeting.\n\n**Design principle:** build deterministic logic into Go code wherever possible. Only use LLM dispatch for work that requires reasoning (narrative synthesis, priority trade-offs, pattern analysis). Status aggregation, dependency graphs, scheduling, rate limit math — all code.\n\n**Key components:**\n- Cross-project dependency tracking (code)\n- Aligned sprint cadence (code)\n- Chief Scrum Master agent (LLM — the coordination brain)\n- Rate limit capacity budgeting per project (code)\n- Cross-project provider performance profiling (code + LLM)\n- Multi-team sprint planning ceremony (LLM via chief SM)\n- Overall retrospective ceremony (LLM via chief SM)\n- Unified sprint review (LLM via chief SM)\n- Definition of Done enforcement (code)\n- Predictive capacity planning (code)\n- Unified backlog API (code)","status":"open","priority":1,"issue_type":"epic","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:36:52.803737261+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:36:52.803737261+10:00"}
{"id":"cortex-xhk.1","title":"Cross-project dependency tracking","description":"Enable beads to depend on beads in other projects. Pure Go code — no LLM needed.\n\n**Current limitation:**\nbd dep add only works within a single project's .beads/ directory. Dependencies are project-scoped. Project B's API integration task can't formally block on Project A's endpoint bead.\n\n**Implementation (all deterministic Go code):**\n\nExtend internal/beads/beads.go:\n- Cross-project bead ID format: {project}:{bead_id} (e.g. 'hg-website:cortex-abc')\n- When DependsOn contains a colon, it's a cross-project dep\n- ListBeads already returns bead IDs — extend to optionally include project prefix\n\nCreate internal/beads/crossdeps.go:\n```go\ntype CrossProjectGraph struct {\n    // project -\u003e bead_id -\u003e []dependency{project, bead_id}\n    Edges map[string]map[string][]CrossDep\n}\n\ntype CrossDep struct {\n    Project string\n    BeadID  string\n}\n\n// BuildCrossProjectGraph scans all enabled projects and builds unified dep graph\nfunc BuildCrossProjectGraph(projects map[string]config.Project) (*CrossProjectGraph, error)\n\n// FilterUnblockedCrossProject returns beads that are unblocked considering cross-project deps\nfunc (g *CrossProjectGraph) FilterUnblocked(project string, beadList []Bead) []Bead\n\n// GetCrossProjectBlockers returns what cross-project deps are blocking a bead\nfunc (g *CrossProjectGraph) GetBlockers(project, beadID string) []CrossDep\n```\n\nUpdate scheduler RunTick:\n- Build CrossProjectGraph once per tick (scans all projects)\n- Use FilterUnblocked instead of FilterUnblockedOpen when cross-deps exist\n- Log cross-project blockers\n\nUpdate internal/api/api.go:\n- GET /dependencies — show cross-project dependency graph\n- Include in project detail endpoint\n\n**No config changes needed** — cross-deps are expressed in bead DependsOn field using the project:bead_id format.\n\nAcceptance: Cross-project deps detected, enforced in scheduler, visible in API","status":"open","priority":1,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:39:19.26966189+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:39:19.26966189+10:00","labels":["code"],"dependencies":[{"issue_id":"cortex-xhk.1","depends_on_id":"cortex-xhk","type":"parent-child","created_at":"2026-02-17T17:39:19.2745517+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-xhk.10","title":"Predictive capacity planning","description":"Predict how long backlogs will take to clear based on velocity. Pure arithmetic — no LLM.\n\n**Implementation:**\n\nCreate internal/learner/forecast.go:\n```go\ntype Forecast struct {\n    Project        string\n    BacklogSize    int       // open beads\n    Velocity       float64   // beads/day (rolling 7d)\n    EstimatedDays  float64   // backlog / velocity\n    EstimatedSprints int     // estimated_days / sprint_length\n    SprintsOfRunway  int     // rate_limit_remaining / avg_dispatches_per_sprint\n    CapacityWarning  string  // 'rate limit will be exhausted in N days'\n}\n\n// ForecastProject predicts backlog completion for a project\nfunc ForecastProject(store *store.Store, project string, cadence *SprintCadence, budget ProjectBudget) (*Forecast, error)\n\n// ForecastPortfolio runs forecast for all projects\nfunc ForecastPortfolio(store *store.Store, projects map[string]config.Project, cadence *SprintCadence) ([]Forecast, error)\n```\n\nIncluded in:\n- Chief SM's PortfolioContext (for planning/retro prompts)\n- API: GET /forecast and GET /forecast/{project}\n- Daily standup (per-project scrum master mentions 'at current velocity, backlog clears in N days')\n\nAcceptance: Forecasts calculate from velocity+backlog, rate limit runway computed, available in API and prompts","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:41:30.290196833+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:41:30.290196833+10:00","labels":["code"],"dependencies":[{"issue_id":"cortex-xhk.10","depends_on_id":"cortex-xhk","type":"parent-child","created_at":"2026-02-17T17:41:30.294575172+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.10","depends_on_id":"cortex-xhk.2","type":"blocks","created_at":"2026-02-17T17:41:49.267352889+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.10","depends_on_id":"cortex-xhk.4","type":"blocks","created_at":"2026-02-17T17:41:49.424603376+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-xhk.11","title":"Unified backlog API endpoint","description":"API endpoint showing beads across all projects in one view. Pure Go code — query aggregation.\n\n**Implementation:**\n\nAdd to internal/api/api.go:\n\nGET /backlog — unified backlog across all projects\n- Query params: ?status=open\u0026project=X\u0026sort=priority\n- Returns beads from all enabled projects with project field added\n- Includes cross-project dependency info\n- Sorted by priority (respecting project priority weight)\n\nGET /backlog/stats — aggregate stats\n- Total open, in_progress, blocked across all projects\n- Per-project breakdown\n- Cross-project blockers count\n\nGET /portfolio — high-level portfolio view\n- Per-project: open/progress/blocked/velocity\n- Overall capacity: rate limit used/remaining\n- Current sprint number and day\n- Next ceremony time\n\nNo LLM needed — this is query aggregation and JSON serialization.\n\nAcceptance: Endpoints return correct cross-project data, filtering works, sorted by priority","status":"open","priority":3,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:41:39.388353475+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:41:39.388353475+10:00","labels":["code"],"dependencies":[{"issue_id":"cortex-xhk.11","depends_on_id":"cortex-xhk","type":"parent-child","created_at":"2026-02-17T17:41:39.390504032+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.11","depends_on_id":"cortex-xhk.1","type":"blocks","created_at":"2026-02-17T17:41:49.577448584+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-xhk.2","title":"Aligned sprint cadence across projects","description":"Align all projects to a shared sprint cadence. Pure Go code — scheduling logic.\n\n**Current state:**\nEach project ticks independently. Sprint planning day/time is per-project. No concept of a shared sprint.\n\n**Implementation:**\n\nAdd to config:\n```toml\n[cadence]\nsprint_length = \"1w\"           # 1w, 2w\nsprint_start_day = \"Monday\"\nsprint_start_time = \"09:00\"\ntimezone = \"UTC\"\n```\n\nCreate internal/scheduler/cadence.go:\n```go\ntype SprintCadence struct {\n    Length    time.Duration\n    StartDay time.Weekday\n    StartTime string  // HH:MM\n    Timezone *time.Location\n}\n\n// CurrentSprint returns the current sprint number and boundaries\nfunc (c *SprintCadence) CurrentSprint() (number int, start, end time.Time)\n\n// IsSprintBoundary returns true if we're within N minutes of sprint start/end\nfunc (c *SprintCadence) IsSprintBoundary(t time.Time, windowMinutes int) (isStart, isEnd bool)\n\n// SprintDay returns which day of the sprint we're on (1-indexed)\nfunc (c *SprintCadence) SprintDay(t time.Time) int\n\n// NextCeremony returns the next scheduled ceremony time\nfunc (c *SprintCadence) NextCeremony() (name string, at time.Time)\n```\n\nCeremony schedule (derived from cadence, no per-project config needed):\n- Sprint planning: sprint start day, start time\n- Daily standup: every day at start time\n- Sprint review: last day of sprint, start time\n- Sprint retro: last day of sprint, start time + 1h\n\nPer-project sprint_planning_day/time in a4s.9 becomes optional override, defaults to cadence.\n\nStore additions:\n- RecordSprintBoundary(sprintNumber, start, end)\n- GetCurrentSprintNumber() int\n\nAcceptance: Unified cadence, ceremonies derive from it, per-project override still works, sprint numbers tracked","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:39:32.081453679+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:39:32.081453679+10:00","labels":["code"],"dependencies":[{"issue_id":"cortex-xhk.2","depends_on_id":"cortex-xhk","type":"parent-child","created_at":"2026-02-17T17:39:32.087561951+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-xhk.3","title":"Implement Chief Scrum Master agent","description":"Create the Chief Scrum Master (Chief SM) — a coordination agent that sits above per-project scrum masters.\n\n**What requires LLM:** Reasoning about cross-project trade-offs, synthesizing patterns across teams, producing actionable coordination decisions. The Chief SM is the only agent that sees ALL projects simultaneously.\n\n**What is code (not LLM):** Agent creation, data gathering, prompt assembly, ceremony scheduling.\n\n**Implementation:**\n\nAdd Chief SM to internal/team/team.go:\n```go\n// New role (not per-project — global)\n\"chief-scrum\": `# Chief Scrum Master Agent\n\nYou are the Chief Scrum Master coordinating across all projects.\n\n## Responsibilities\n- Run multi-team sprint planning: allocate work across projects\n- Run overall retrospective: spot systemic patterns across teams\n- Mediate resource contention: when projects compete for capacity\n- Escalate impediments that individual scrum masters can't resolve\n- Ensure cross-project dependencies are tracked and unblocked\n\n## You communicate via Matrix in the coordination room\n- Summarize cross-team status\n- Flag systemic risks\n- Propose capacity allocation changes\n\n## You do NOT\n- Refine individual beads (that's the project scrum master)\n- Make product decisions (that's the human PO)\n`\n```\n\nAgent naming: 'cortex-chief-scrum' (not project-prefixed — it's global)\n\nCreate internal/scheduler/chief.go:\n```go\ntype ChiefSM struct {\n    store      *store.Store\n    dispatcher *dispatch.Dispatcher\n    cfg        *config.Config\n    logger     *slog.Logger\n}\n\n// GatherPortfolioContext builds context across ALL projects (code, not LLM)\nfunc (c *ChiefSM) GatherPortfolioContext() *PortfolioContext\n\ntype PortfolioContext struct {\n    Projects       []ProjectSummary  // per-project stats\n    CrossDeps      []CrossDepStatus  // unresolved cross-deps\n    RateLimitUsage RateLimitSummary  // global capacity state\n    ProviderHealth map[string]ProviderHealthSummary\n    SprintNumber   int\n    SprintDay      int\n}\n\ntype ProjectSummary struct {\n    Name           string\n    OpenBeads      int\n    InProgress     int\n    Blocked        int\n    CompletedThisSprint int\n    FailedThisSprint    int\n    Velocity       float64\n    ScrumMasterAgent string\n}\n```\n\nConfig:\n```toml\n[chief]\nenabled = true\nmatrix_room = \"!coordination:matrix.org\"   # separate room for cross-team coordination\nmodel = \"claude-opus-4-6\"                  # always Opus\n```\n\nThe Chief SM dispatches are always premium tier. It only runs for ceremonies (not per-tick), so rate limit impact is minimal.\n\nAcceptance: Chief SM agent exists, GatherPortfolioContext works, config parsed, agent created on startup","status":"open","priority":1,"issue_type":"feature","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:39:54.054416696+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:39:54.054416696+10:00","dependencies":[{"issue_id":"cortex-xhk.3","depends_on_id":"cortex-xhk","type":"parent-child","created_at":"2026-02-17T17:39:54.058618895+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.3","depends_on_id":"cortex-xhk.1","type":"blocks","created_at":"2026-02-17T17:41:47.700075134+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.3","depends_on_id":"cortex-xhk.2","type":"blocks","created_at":"2026-02-17T17:41:47.839437407+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-xhk.4","title":"Rate limit capacity budgeting per project","description":"Allocate rate limit budget across projects instead of first-come-first-served. Pure Go code — arithmetic and enforcement.\n\n**Current problem:**\nRate limits are global. If project A is high priority and project B is low priority, B can still exhaust the weekly cap before A gets its work done. The rate limiter doesn't know about project priority.\n\n**Implementation (all deterministic code):**\n\nConfig:\n```toml\n[rate_limits]\nwindow_5h_cap = 20\nweekly_cap = 200\n\n# Budget allocation (must sum to 100)\n[rate_limits.budget]\nhg-website = 60      # 60% of weekly cap = 120 dispatches\nother-project = 40   # 40% = 80 dispatches\n```\n\nIf no budget section exists, fall back to current behavior (shared pool).\n\nExtend internal/dispatch/ratelimit.go:\n```go\n// BudgetedCanDispatch checks project-specific budget before dispatching\nfunc (rl *RateLimiter) BudgetedCanDispatch(project string) (bool, string)\n\n// ProjectBudget returns remaining capacity for a project\nfunc (rl *RateLimiter) ProjectBudget(project string) (used, cap int)\n\n// RebalanceBudget allows Chief SM to temporarily shift allocation (e.g. 'all hands on A')\nfunc (rl *RateLimiter) RebalanceBudget(allocations map[string]int) error\n```\n\nStore query:\n- CountAuthedUsageByProject(project, window) — already have provider-level, add project grouping\n\nScheduler integration:\n- RunTick checks BudgetedCanDispatch(project) before picking provider\n- If project budget exhausted but global cap has room, log it but don't dispatch\n\nAPI addition:\n- GET /status includes per-project budget: used/cap/remaining\n\nAcceptance: Budget enforced per project, fallback to shared pool if unconfigured, rebalance API works","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:40:10.215643736+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:40:10.215643736+10:00","labels":["code"],"dependencies":[{"issue_id":"cortex-xhk.4","depends_on_id":"cortex-xhk","type":"parent-child","created_at":"2026-02-17T17:40:10.450122079+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-xhk.5","title":"Cross-project provider performance profiling","description":"Aggregate provider performance stats across all projects and detect patterns. Mostly Go code for stats, with optional LLM analysis in retro.\n\n**What is code:** Aggregating success/fail rates by provider × label/type across projects. Detecting statistical patterns (e.g. 'provider X fails \u003e50% on label:go'). Building skill profiles.\n\n**What is LLM (handled in overall retro, not here):** Interpreting why a provider fails and recommending what to do about it.\n\n**Implementation:**\n\nCreate internal/learner/profiles.go:\n```go\ntype ProviderProfile struct {\n    Provider     string\n    TotalDispatches int\n    SuccessRate  float64\n    AvgDuration  float64\n    // Performance by label\n    LabelStats   map[string]LabelPerformance\n    // Performance by bead type\n    TypeStats    map[string]LabelPerformance\n}\n\ntype LabelPerformance struct {\n    Label       string\n    Total       int\n    SuccessRate float64\n    AvgDuration float64\n    Trend       string // improving, stable, degrading\n}\n\n// BuildProviderProfiles aggregates stats across all projects\nfunc BuildProviderProfiles(store *store.Store, window time.Duration) (map[string]ProviderProfile, error)\n\n// DetectWeaknesses returns provider+label combos with \u003e40% failure rate and \u003e=3 samples\nfunc DetectWeaknesses(profiles map[string]ProviderProfile) []Weakness\n\ntype Weakness struct {\n    Provider    string\n    Label       string\n    FailureRate float64\n    SampleSize  int\n    Suggestion  string  // deterministic: 'deprioritize for label:go'\n}\n\n// ApplyProfileToTierSelection adjusts tier/provider selection based on profiles\n// e.g. if provider X is weak on label:go, skip it for Go beads even if it's in the right tier\nfunc ApplyProfileToTierSelection(profiles map[string]ProviderProfile, bead beads.Bead, candidates []string) []string\n```\n\nStore additions:\n- Dispatches already store provider and tier. Need to also store bead labels (add labels column to dispatches table) so we can query performance by label.\n- Query: GetProviderLabelStats(window) — group by provider, label, count success/fail\n\nIntegration:\n- Scheduler calls ApplyProfileToTierSelection when picking provider — filters out providers known to be weak for this bead's labels\n- Profiles rebuilt periodically (every N ticks or daily), cached in memory\n- Weaknesses included in portfolio context for Chief SM retro\n\nAcceptance: Profiles built from dispatch history, weaknesses detected, weak providers filtered from selection, data available for retro","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:40:28.427985135+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:40:28.427985135+10:00","labels":["code"],"dependencies":[{"issue_id":"cortex-xhk.5","depends_on_id":"cortex-xhk","type":"parent-child","created_at":"2026-02-17T17:40:28.431917212+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-xhk.6","title":"Multi-team sprint planning ceremony","description":"Chief SM runs a unified sprint planning across all projects. LLM for reasoning about allocation trade-offs.\n\n**What is code:** Gathering backlogs, calculating capacity, enforcing budget constraints, recording sprint plan.\n**What is LLM (Chief SM dispatch):** Reasoning about priority trade-offs, resolving cross-project conflicts, producing allocation rationale.\n\n**Implementation:**\n\nExtend internal/scheduler/chief.go:\n\nfunc (c *ChiefSM) RunMultiTeamPlanning(ctx):\n\nCode (before dispatch):\n1. Gather all project backlogs (unrefined + refined beads across all projects)\n2. Build cross-project dependency graph\n3. Calculate per-project capacity budget (from rate_limits.budget)\n4. Get provider profiles (what's working, what's weak)\n5. Get each project's sprint planning results if already run (from a4s.9)\n6. Package into PortfolioContext\n\nLLM (Chief SM dispatch at premium/Opus tier):\n7. Chief SM receives PortfolioContext + all backlogs\n8. Reviews cross-project dependencies: 'Project B needs endpoint from Project A — prioritize A's endpoint bead'\n9. Allocates capacity: 'Project A gets 60% this sprint (critical deadline), B gets 40%'\n10. Identifies conflicts: 'Both projects want premium tier for similar work — stagger them'\n11. Produces unified sprint plan sent to coordination Matrix room\n\nAfter dispatch (code):\n12. Record allocations in store\n13. Update rate limit budgets if Chief SM recommended rebalancing\n\nScheduling: runs at sprint start (from cadence config), BEFORE individual project sprint planning.\nOrder: Chief SM multi-team planning → per-project scrum master sprint planning (a4s.9)\n\nPrompt template: 'sprint_planning_multi' — includes all project backlogs, cross-deps, capacity, profiles.\n\nAcceptance: Chief SM sees all projects, reasons about allocation, produces unified plan, runs before per-project planning","status":"open","priority":1,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:40:43.697836427+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:40:43.697836427+10:00","dependencies":[{"issue_id":"cortex-xhk.6","depends_on_id":"cortex-xhk","type":"parent-child","created_at":"2026-02-17T17:40:43.727751168+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.6","depends_on_id":"cortex-xhk.3","type":"blocks","created_at":"2026-02-17T17:41:47.987719672+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.6","depends_on_id":"cortex-xhk.4","type":"blocks","created_at":"2026-02-17T17:41:48.123624311+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.6","depends_on_id":"cortex-xhk.5","type":"blocks","created_at":"2026-02-17T17:41:48.26979425+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-xhk.7","title":"Overall retrospective ceremony","description":"Chief SM runs a meta-retrospective across all projects. LLM for pattern analysis.\n\n**What is code:** Aggregating per-project retro data, cross-project stats, systemic metrics.\n**What is LLM (Chief SM dispatch):** Spotting systemic patterns, producing cross-cutting recommendations.\n\n**Implementation:**\n\nExtend internal/scheduler/chief.go:\n\nfunc (c *ChiefSM) RunOverallRetro(ctx):\n\nCode (data gathering):\n1. Collect per-project RetroReports (from retro.go)\n2. Aggregate: total dispatches, failures, velocity across all projects\n3. Build cross-project provider profiles (from profiles.go)\n4. Get cross-project dependency resolution stats: how many cross-deps resolved this sprint, how many are still blocking\n5. Rate limit usage: per-project budget utilization, any project starved?\n6. Compare sprint plan vs actual across all projects\n\nLLM (Chief SM dispatch at premium/Opus tier):\n7. Chief SM receives all aggregated data\n8. Identifies systemic patterns:\n   - 'Provider X is underperforming across ALL projects, not just one'\n   - 'Cross-project deps are the #1 blocker — 3 beads blocked for \u003e3 days'\n   - 'Tier misclassification is 30% globally — complexity detection needs tuning'\n   - 'Project A is starving Project B of capacity — rebalance budget'\n9. Produces action items:\n   - Code-level: 'adjust complexity thresholds' (can create beads)\n   - Config-level: 'deprioritize provider X' (can suggest config changes)\n   - Process-level: 'require estimates on all beads before sprint planning'\n10. Sends to coordination Matrix room\n\nScheduling: runs at sprint end (from cadence), AFTER per-project retros.\nOrder: per-project retros (a4s.11) → Chief SM overall retro\n\nAcceptance: Chief SM analyzes cross-project patterns, produces systemic recommendations, creates follow-up beads if needed","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:40:57.016207201+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:40:57.016207201+10:00","dependencies":[{"issue_id":"cortex-xhk.7","depends_on_id":"cortex-xhk","type":"parent-child","created_at":"2026-02-17T17:40:57.018624225+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.7","depends_on_id":"cortex-xhk.3","type":"blocks","created_at":"2026-02-17T17:41:48.515419988+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.7","depends_on_id":"cortex-xhk.5","type":"blocks","created_at":"2026-02-17T17:41:48.71094653+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-xhk.8","title":"Unified sprint review","description":"Chief SM produces a single sprint review summarizing what shipped across all projects. LLM for narrative synthesis.\n\n**What is code:** Gathering completed beads, velocity, stats per project.\n**What is LLM (Chief SM dispatch):** Synthesizing a coherent narrative of what shipped, for the human PO.\n\n**Implementation:**\n\nExtend internal/scheduler/chief.go:\n\nfunc (c *ChiefSM) RunUnifiedReview(ctx):\n\nCode:\n1. For each project: list beads closed during this sprint\n2. Calculate: planned (from sprint plan) vs delivered\n3. Get velocity per project and overall\n4. Identify scope changes mid-sprint\n\nLLM (Chief SM at premium tier):\n5. Produce portfolio-level narrative:\n   - What shipped across all projects (grouped by project)\n   - Overall completion rate: N/M planned beads across all projects\n   - Cross-project milestones: 'Project A's API is done, unblocking Project B'\n   - Risks carrying into next sprint\n6. Send to coordination Matrix room (and optionally to per-project rooms)\n\nScheduling: sprint end, before retro.\nOrder: unified review → per-project retros → overall retro\n\nAcceptance: Narrative covers all projects, planned vs delivered, sent to Matrix","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:41:06.716314596+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:41:06.716314596+10:00","dependencies":[{"issue_id":"cortex-xhk.8","depends_on_id":"cortex-xhk","type":"parent-child","created_at":"2026-02-17T17:41:06.721542958+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.8","depends_on_id":"cortex-xhk.3","type":"blocks","created_at":"2026-02-17T17:41:48.847793786+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-xhk.8","depends_on_id":"cortex-xhk.2","type":"blocks","created_at":"2026-02-17T17:41:49.122137158+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-xhk.9","title":"Definition of Done enforcement","description":"Configurable per-project DoD that the ops/qa agent checks. Pure Go code — run commands, check results.\n\n**Implementation:**\n\nConfig:\n```toml\n[projects.hg-website.dod]\nchecks = [\n    \"go test ./...\",\n    \"go vet ./...\",\n    \"golangci-lint run\",\n]\ncoverage_min = 70          # optional: fail if coverage \u003c N%\nrequire_estimate = true    # bead must have estimate before closing\nrequire_acceptance = true  # bead must have acceptance criteria\n```\n\nCreate internal/scheduler/dod.go:\n```go\ntype DoDChecker struct {\n    checks          []string\n    coverageMin     int\n    requireEstimate bool\n    requireAcceptance bool\n}\n\n// CheckDoD runs all DoD checks in the project workspace. Returns pass/fail with details.\n// This is called by the scheduler when a dispatch completes (before marking bead as done).\nfunc (d *DoDChecker) Check(ctx context.Context, workspace string, bead beads.Bead) (*DoDResult, error)\n\ntype DoDResult struct {\n    Passed  bool\n    Checks  []CheckResult  // per-command results\n    Failures []string       // human-readable failure reasons\n}\n\ntype CheckResult struct {\n    Command  string\n    ExitCode int\n    Output   string  // truncated\n    Passed   bool\n}\n```\n\nIntegration:\n- After ops/qa agent completes and before bd close, scheduler runs DoDChecker\n- If DoD fails, bead transitions back to stage:coding with failure notes\n- DoD results recorded in store for retro analysis\n- No LLM needed — this is running commands and checking exit codes\n\nAcceptance: DoD checks run on completion, failures block closing, results recorded, configurable per project","status":"open","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","created_at":"2026-02-17T17:41:18.931164144+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T17:41:18.931164144+10:00","labels":["code"],"dependencies":[{"issue_id":"cortex-xhk.9","depends_on_id":"cortex-xhk","type":"parent-child","created_at":"2026-02-17T17:41:18.953268002+10:00","created_by":"Simon Heikkila"}]}
