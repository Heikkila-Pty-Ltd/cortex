{"id":"cortex-08z","title":"Phase 1: Cortex Core — Scheduler + Rate Limiter","description":"Working Go binary that reads beads from project dirs, builds dependency graphs, finds unblocked tasks, respects unified rate limits, dispatches openclaw agents, and tracks state in SQLite. This is the core scheduling engine.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":480,"created_at":"2026-02-17T13:33:07.156580998+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:54:32.932625657+10:00","closed_at":"2026-02-17T14:54:32.932625657+10:00","close_reason":"Phase 1 complete: all 10 tasks done, binary builds and tests pass","labels":["core","phase-1"]}
{"id":"cortex-08z.1","title":"Go module init + project scaffold","description":"Initialize Go module and create the full directory structure:\n\n  go mod init github.com/antigravity-dev/cortex\n  \nCreate all package directories per module layout:\n  cmd/cortex/, internal/config/, internal/beads/, internal/scheduler/,\n  internal/dispatch/, internal/health/, internal/learner/, internal/api/, internal/store/\n\nAdd core dependencies:\n  modernc.org/sqlite (pure-Go SQLite driver)\n  github.com/BurntSushi/toml (config parsing)\n\nCreate minimal main.go with signal handling skeleton (SIGINT/SIGTERM graceful shutdown).\nCreate Makefile with build, install, clean targets.\n\nAcceptance criteria:\n- go build ./cmd/cortex/ produces a working binary\n- Binary starts and exits cleanly on SIGINT\n- All package dirs exist with placeholder .go files","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":30,"created_at":"2026-02-17T13:45:59.053458725+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:40:50.31309257+10:00","closed_at":"2026-02-17T14:40:50.31309257+10:00","close_reason":"Scaffold complete: go mod, all packages, main.go with signal handling, Makefile, deps installed, builds clean","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.1","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:45:59.057613426+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.10","title":"Main binary entry point + systemd unit","description":"Wire everything together in cmd/cortex/main.go and create the systemd service file.\n\nmain.go:\n1. Parse flags: --config (default: cortex.toml), --once (run single tick then exit, for testing)\n2. Load config via config.Load()\n3. Open store via store.Open(config.StateDB)\n4. Create rateLimiter, dispatcher, scheduler\n5. Start scheduler in goroutine\n6. Block on signal (SIGINT/SIGTERM) for graceful shutdown\n7. On shutdown: cancel context, wait for running tick to finish, close store\n\ncortex.service (systemd user unit):\n  [Unit]\n  Description=Cortex Agent Orchestrator\n  After=openclaw-gateway.service\n\n  [Service]\n  Type=simple\n  ExecStart=%h/projects/cortex/cortex --config %h/projects/cortex/cortex.toml\n  Restart=always\n  RestartSec=10\n  Environment=PATH=%h/.local/bin:/usr/local/bin:/usr/bin\n\n  [Install]\n  WantedBy=default.target\n\nMakefile targets:\n  build: go build -o cortex ./cmd/cortex/\n  install: cp cortex ~/.local/bin/\n  service-install: cp cortex.service ~/.config/systemd/user/ \u0026\u0026 systemctl --user daemon-reload\n  service-start: systemctl --user enable --now cortex.service\n\nAcceptance criteria:\n- cortex binary starts, runs one tick with --once flag, exits cleanly\n- cortex binary runs continuously and responds to SIGTERM\n- systemd unit installs and starts correctly\n- Logs appear in journalctl --user -u cortex.service","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":45,"created_at":"2026-02-17T14:12:41.806052224+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:54:32.551083368+10:00","closed_at":"2026-02-17T14:54:32.551083368+10:00","close_reason":"Main binary, systemd unit, and Makefile all implemented","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.10","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T14:12:41.809619678+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.10","depends_on_id":"cortex-08z.9","type":"blocks","created_at":"2026-02-17T14:12:41.815717384+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.2","title":"TOML config loader","description":"Implement internal/config/config.go that parses cortex.toml into typed Go structs.\n\nStructs needed:\n- Config (top-level): General, Projects map, RateLimits, Providers map, Tiers, Health, Reporter, API\n- General: TickInterval (duration), MaxPerTick (int), StuckTimeout (duration), MaxRetries (int), LogLevel (string), StateDB (path)\n- Project: Enabled (bool), BeadsDir (path), Workspace (path), Priority (int)\n- RateLimits: Window5hCap (int), WeeklyCap (int), WeeklyHeadroomPct (int)\n- Provider: Tier (string), Authed (bool), Model (string)\n- Tiers: Fast, Balanced, Premium ([]string provider names)\n- Health: CheckInterval (duration), GatewayUnit (string)\n- Reporter: Channel (string), AgentID (string), DailyDigestTime (string), WeeklyRetroDay (string)\n- API: Bind (string)\n\nValidate on load: all provider names in tiers exist in providers map, at least one project enabled, state_db dir exists.\n\nCreate the default cortex.toml with all providers and hg-website as the initial enabled project.\n\nAcceptance criteria:\n- Config loads from cortex.toml successfully\n- Invalid configs return descriptive errors\n- Unit test covers: valid config, missing required fields, unknown provider in tier","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T13:50:22.592398066+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:50.180842457+10:00","closed_at":"2026-02-17T14:48:50.180842457+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.2","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:50:22.618547657+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.2","depends_on_id":"cortex-08z.1","type":"blocks","created_at":"2026-02-17T13:50:22.636563313+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.3","title":"SQLite store layer","description":"Implement internal/store/store.go with SQLite operations.\n\nOn first run, auto-create schema:\n- dispatches table (id, bead_id, project, agent_id, provider, tier, pid, prompt, dispatched_at, completed_at, status, exit_code, duration_s, retries, escalated_from_tier)\n- provider_usage table (id, provider, agent_id, bead_id, dispatched_at)\n- health_events table (id, event_type, details, created_at)\n- tick_metrics table (id, tick_at, project, beads_open, beads_ready, dispatched, completed, failed, stuck)\n\nCRUD methods:\n- RecordDispatch(beadID, project, agent, provider, tier, pid, prompt) -\u003e id\n- UpdateDispatchStatus(id, status, exitCode, durationS)\n- GetRunningDispatches() -\u003e []Dispatch\n- GetStuckDispatches(timeout duration) -\u003e []Dispatch\n- RecordProviderUsage(provider, agentID, beadID)\n- CountAuthedUsage5h() -\u003e int\n- CountAuthedUsageWeekly() -\u003e int\n- RecordHealthEvent(eventType, details)\n- RecordTickMetrics(project, open, ready, dispatched, completed, failed, stuck)\n\nIndexes: idx_dispatches_status, idx_dispatches_bead, idx_usage_provider(provider, dispatched_at)\n\nAcceptance criteria:\n- All tables created on first Open()\n- All CRUD methods work with unit tests\n- Concurrent access safe (WAL mode enabled)\n- Database path from config.StateDB","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":90,"created_at":"2026-02-17T13:52:01.773492457+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:52:09.214755913+10:00","closed_at":"2026-02-17T14:52:09.214755913+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.3","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:52:01.785318491+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.3","depends_on_id":"cortex-08z.2","type":"blocks","created_at":"2026-02-17T13:52:01.796104448+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.4","title":"Beads CLI wrapper","description":"Implement internal/beads/beads.go that wraps the bd CLI to read bead data from project directories.\n\nFunctions:\n- ListBeads(beadsDir string) -\u003e []Bead, error\n  Runs: bd list --json --quiet in the given directory\n  Parses JSON into Bead structs\n\n- ShowBead(beadsDir, beadID string) -\u003e BeadDetail, error\n  Runs: bd show --json {beadID}\n\n- CloseBead(beadsDir, beadID string) -\u003e error\n  Runs: bd close {beadID}\n\nBead struct fields:\n  ID, Title, Description, Status, Priority, Type, Labels []string,\n  EstimateMinutes int, ParentID string, DependsOn []string,\n  Acceptance string, Design string, CreatedAt time.Time\n\nBuildDepGraph(beads []Bead) -\u003e *DepGraph\n  Builds a directed graph from DependsOn + ParentID edges.\n  \nFilterUnblockedOpen(graph *DepGraph) -\u003e []Bead\n  Returns beads that are: status=open AND all DependsOn beads are closed AND parent is open (not skipped).\n  Sorted by: Priority ASC (P0 first), then EstimateMinutes ASC.\n\nAcceptance criteria:\n- ListBeads correctly parses bd list --json output\n- DepGraph correctly identifies unblocked beads\n- Unit tests with sample JSON fixtures (no actual bd calls)\n- Handles empty bead lists gracefully","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":90,"created_at":"2026-02-17T13:52:33.664382221+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:50.205960855+10:00","closed_at":"2026-02-17T14:48:50.205960855+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.4","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:52:33.668720161+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.4","depends_on_id":"cortex-08z.1","type":"blocks","created_at":"2026-02-17T13:52:33.674972084+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.5","title":"Unified rate limiter","description":"Implement internal/dispatch/ratelimit.go with the unified authed rate limiter.\n\nCore concept: All authed subscription providers (Claude Max20, OpenAI Pro, Google Pro, Kimi) share two hard gates — a 5h rolling window cap and a weekly cap. Free-tier providers (cerebras, groq) are uncapped.\n\nFunctions:\n- NewRateLimiter(store *store.Store, cfg config.RateLimits) -\u003e *RateLimiter\n- CanDispatchAuthed() -\u003e (bool, string reason)\n  Checks both gates against store.CountAuthedUsage5h() and store.CountAuthedUsageWeekly()\n  Returns false + reason if either gate exceeded\n- RecordAuthedDispatch(provider, agentID, beadID string)\n  Delegates to store.RecordProviderUsage()\n- WeeklyUsagePct() -\u003e float64\n  Returns current weekly usage as percentage of cap\n- IsInHeadroomWarning() -\u003e bool\n  Returns true if WeeklyUsagePct \u003e= config.WeeklyHeadroomPct (default 80%)\n\nAlgorithm for provider selection within a tier:\n- PickProvider(tier string, providers []config.Provider) -\u003e *config.Provider\n  1. If tier is fast -\u003e pick from free providers (no quota check)\n  2. If tier is balanced/premium -\u003e check CanDispatchAuthed()\n  3. If authed gates pass -\u003e return first available provider in tier order\n  4. If gates fail -\u003e return nil (caller handles tier downgrade)\n\nTier downgrade logic (in scheduler, not here):\n  premium -\u003e balanced -\u003e fast, or defer to next tick\n\nAcceptance criteria:\n- 5h rolling window correctly counts dispatches in last 5 hours\n- Weekly rolling window correctly counts dispatches in last 7 days\n- Free-tier providers bypass all gates\n- Headroom warning triggers at configured percentage\n- Unit tests with seeded usage data covering: under cap, at cap, over cap, headroom warning","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T13:52:59.000042143+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:52:58.486999173+10:00","closed_at":"2026-02-17T14:52:58.486999173+10:00","close_reason":"Rate limiter implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.5","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:52:59.002997357+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.5","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T13:52:59.008672868+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.6","title":"Role inference + complexity detection","description":"Implement internal/scheduler/role.go and internal/scheduler/complexity.go.\n\nRole inference (role.go):\n- InferRole(bead Bead) -\u003e string\n  Maps bead labels/type to agent role:\n  | Bead Labels / Type | Role |\n  | Any open bead with code files listed | coder |\n  | Label contains review, test, qa | reviewer |\n  | Label contains deploy, ops, ci | ops |\n  | Type = epic | skip (Cortex tracks epic completion automatically) |\n  | Default | coder |\n  \n- ResolveAgent(project string, role string) -\u003e string\n  Returns '{project}-{role}' (e.g. 'hg-website-coder')\n  Falls back to 'main-{role}' if project-specific agent doesn't exist\n\nComplexity detection (complexity.go):\n- DetectComplexity(bead Bead) -\u003e string (tier: fast|balanced|premium)\n  | Signal | Tier |\n  | estimated_minutes \u003c= 30 | fast |\n  | estimated_minutes 31-90 | balanced |\n  | estimated_minutes \u003e 90 | premium |\n  | Label complex or architecture | premium |\n  | Label trivial or chore | fast |\n  Labels override time-based detection.\n\nAcceptance criteria:\n- Role correctly inferred from labels with priority ordering\n- Complexity correctly maps estimate + labels to tier\n- Label override takes precedence over time estimate\n- Unit tests cover all mapping combinations","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":45,"created_at":"2026-02-17T13:56:22.89995188+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:52:09.244025453+10:00","closed_at":"2026-02-17T14:52:09.244025453+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.6","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:56:22.903471817+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.6","depends_on_id":"cortex-08z.4","type":"blocks","created_at":"2026-02-17T13:56:22.908012317+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.7","title":"Agent prompt builder","description":"Implement internal/scheduler/prompt.go that constructs the prompt sent to openclaw agents.\n\nFunction:\n- BuildPrompt(bead Bead, project config.Project) -\u003e string\n\nTemplate:\n  You are working on project {project_name} in {workspace_dir}.\n\n  ## Task: {bead.title} ({bead.id})\n\n  {bead.description}\n\n  ## Acceptance Criteria\n  {bead.acceptance}\n\n  ## Design Notes\n  {bead.design}\n\n  ## Instructions\n  1. Read the acceptance criteria carefully\n  2. Implement in the files listed (create if needed)\n  3. Run tests if they exist\n  4. Commit with message: feat({bead.id}): {short_title}\n  5. When done, run: bd close {bead.id}\n  6. Push: git push\n\n  ## Context Files\n  {extracted file paths from bead description}\n\nFile extraction: scan description for paths matching common patterns (src/, internal/, *.go, *.ts, *.py, etc.)\n\nAcceptance criteria:\n- Prompt includes all bead metadata (title, description, acceptance, design)\n- File paths extracted from description\n- Template is readable and well-structured\n- Unit test verifies template rendering with sample bead","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":30,"created_at":"2026-02-17T13:56:47.58364861+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:52:09.287511394+10:00","closed_at":"2026-02-17T14:52:09.287511394+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.7","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:56:47.587726938+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.7","depends_on_id":"cortex-08z.4","type":"blocks","created_at":"2026-02-17T13:56:47.59525896+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.8","title":"OpenClaw agent dispatcher","description":"Implement internal/dispatch/dispatcher.go that wraps the openclaw CLI to dispatch agents.\n\nFunctions:\n- Dispatch(agent string, prompt string, provider string, thinkingLevel string) -\u003e (pid int, error)\n  Runs: openclaw agent --agent {agent} --message {prompt} --thinking {thinkingLevel}\n  Starts process in background, returns PID for tracking.\n  thinkingLevel derived from tier: fast=none, balanced=low, premium=high\n\n- IsProcessAlive(pid int) -\u003e bool\n  Checks if PID is still running via kill -0\n\n- KillProcess(pid int) -\u003e error\n  Sends SIGTERM, waits 5s, then SIGKILL if still alive\n\nEnvironment setup:\n  Ensure openclaw binary is in PATH\n  Set CWD to project workspace directory\n\nAcceptance criteria:\n- Dispatch starts an openclaw agent process and returns valid PID\n- IsProcessAlive correctly reports live/dead processes\n- KillProcess terminates gracefully with fallback to SIGKILL\n- Unit tests mock exec.Command for isolation\n- Integration test (manual): dispatches a real agent with a trivial prompt, confirms PID tracking","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T13:58:10.798997021+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:50.233413221+10:00","closed_at":"2026-02-17T14:48:50.233413221+10:00","close_reason":"Implemented with tests, all passing","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.8","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T13:58:10.801768094+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.8","depends_on_id":"cortex-08z.1","type":"blocks","created_at":"2026-02-17T13:58:10.857391397+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-08z.9","title":"Core scheduler tick loop","description":"Implement internal/scheduler/scheduler.go — the main orchestration loop that ties everything together.\n\nScheduler struct holds references to: config, store, rateLimiter, dispatcher, logger.\n\nRunTick() method (called every config.TickInterval):\n1. For each enabled project (sorted by priority):\n   a. beads = ListBeads(project.BeadsDir)\n   b. graph = BuildDepGraph(beads)\n   c. ready = FilterUnblockedOpen(graph)\n   d. Record tick metrics (beads_open, beads_ready counts)\n   \n2. For each ready bead (up to maxPerTick across all projects):\n   a. Skip if alreadyDispatched (check store.GetRunningDispatches)\n   b. role = InferRole(bead) — skip if epic\n   c. tier = DetectComplexity(bead)\n   d. provider = rateLimiter.PickProvider(tier)\n   e. If provider nil: try tier downgrade (premium-\u003ebalanced-\u003efast), log if all exhausted\n   f. prompt = BuildPrompt(bead, project)\n   g. agent = ResolveAgent(project.Name, role)\n   h. pid = dispatcher.Dispatch(agent, prompt, provider, thinkingLevel)\n   i. store.RecordDispatch(bead.ID, project.Name, agent, provider, tier, pid, prompt)\n   j. rateLimiter.RecordAuthedDispatch(provider) if authed\n   \n3. CheckRunningDispatches():\n   a. For each running dispatch in store:\n   b. If PID dead -\u003e mark completed or failed based on exit code\n   c. Record duration\n\nStart() method:\n  Runs RunTick in a goroutine on a ticker, respects context cancellation for graceful shutdown.\n\nAcceptance criteria:\n- Tick loop iterates projects by priority\n- Respects maxPerTick limit across all projects\n- Skips already-dispatched beads (no double dispatch)\n- Tier downgrade works: premium-\u003ebalanced-\u003efast\n- Running dispatch status polling detects completed/failed\n- Integration test: mock all deps, verify dispatch sequence with sample beads\n- Structured logging (slog) for each dispatch decision","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":120,"created_at":"2026-02-17T14:07:02.448542707+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:53:43.738555982+10:00","closed_at":"2026-02-17T14:53:43.738555982+10:00","close_reason":"Scheduler tick loop implemented, all tests pass","labels":["core","phase-1"],"dependencies":[{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z","type":"parent-child","created_at":"2026-02-17T14:07:02.453104918+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:07:02.459620762+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.4","type":"blocks","created_at":"2026-02-17T14:07:02.463452132+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.5","type":"blocks","created_at":"2026-02-17T14:07:02.467106582+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.6","type":"blocks","created_at":"2026-02-17T14:07:02.470851552+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.7","type":"blocks","created_at":"2026-02-17T14:07:02.474640783+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-08z.9","depends_on_id":"cortex-08z.8","type":"blocks","created_at":"2026-02-17T14:07:02.478246162+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-0kw","title":"Phase 5: Status API + Polish","description":"HTTP status endpoints (/status, /projects/{id}, /health, /metrics), Makefile with build/install/service-install targets, graceful shutdown, structured logging (slog), README.md with architecture overview.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":240,"created_at":"2026-02-17T13:40:32.974740877+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T15:03:00.339150723+10:00","closed_at":"2026-02-17T15:03:00.339150723+10:00","close_reason":"Closed","labels":["api","phase-5","polish"]}
{"id":"cortex-0kw.1","title":"HTTP status API","description":"Implement internal/api/api.go — lightweight HTTP API for querying Cortex state.\n\nEndpoints:\n- GET /status -\u003e overall Cortex status (uptime, last tick, dispatches running, rate limiter state)\n- GET /projects -\u003e list of enabled projects with bead counts (open, ready, running, completed)\n- GET /projects/{id} -\u003e detailed project view: recent dispatches, ready beads, velocity\n- GET /health -\u003e health check summary: gateway status, recent health events, stuck count\n- GET /metrics -\u003e Prometheus-compatible metrics: dispatches_total, dispatches_failed_total, rate_limiter_usage_ratio, tick_duration_seconds\n\nServer:\n- net/http stdlib (no framework needed for 5 endpoints)\n- Bind to config.API.Bind (default 127.0.0.1:8900)\n- JSON responses with proper Content-Type headers\n- Starts as goroutine from main.go, shutdown via context cancellation\n\nAcceptance criteria:\n- All 5 endpoints return valid JSON\n- /health returns 200 when healthy, 503 when gateway down\n- /metrics compatible with Prometheus scraping format\n- Server starts on configured bind address\n- Graceful shutdown on context cancellation\n- Unit tests for each endpoint handler with mock store data","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:25:40.41699718+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T15:01:50.741273815+10:00","closed_at":"2026-02-17T15:01:50.741273815+10:00","close_reason":"Closed","labels":["api","phase-5"],"dependencies":[{"issue_id":"cortex-0kw.1","depends_on_id":"cortex-0kw","type":"parent-child","created_at":"2026-02-17T14:25:40.443618494+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-0kw.1","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:25:40.487881873+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-0kw.1","depends_on_id":"cortex-08z.10","type":"blocks","created_at":"2026-02-17T14:25:40.506134929+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-0kw.2","title":"Structured logging with slog","description":"Replace all fmt.Printf/log.Printf calls with Go's structured logging (log/slog).\n\nSetup:\n- Configure slog in main.go based on config.LogLevel (debug/info/warn/error)\n- Use slog.With() for per-component loggers: scheduler, dispatcher, health, api, learner\n- JSON output format for machine parsing, text format for development (--dev flag)\n\nLog key events with structured fields:\n- Dispatch: bead_id, project, agent, provider, tier, pid\n- Completion: bead_id, duration_s, exit_code, status\n- Rate limit: tier, usage_5h, usage_weekly, cap_5h, cap_weekly\n- Health: event_type, details, action_taken\n- Tick: project, beads_open, beads_ready, dispatched_count\n\nAcceptance criteria:\n- All log output uses slog with structured fields\n- Log level configurable via cortex.toml\n- JSON format in production, text in dev\n- No raw fmt.Printf left in non-test code\n- Logs parseable by standard log aggregators","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":30,"created_at":"2026-02-17T14:26:00.96225876+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T15:01:50.781848424+10:00","closed_at":"2026-02-17T15:01:50.781848424+10:00","close_reason":"Closed","labels":["phase-5","polish"],"dependencies":[{"issue_id":"cortex-0kw.2","depends_on_id":"cortex-0kw","type":"parent-child","created_at":"2026-02-17T14:26:01.00291675+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-0kw.2","depends_on_id":"cortex-08z.10","type":"blocks","created_at":"2026-02-17T14:26:01.074752193+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-0kw.3","title":"Graceful shutdown + README","description":"Polish the binary for production use.\n\nGraceful shutdown (enhance main.go):\n1. On SIGTERM/SIGINT: set shutdown flag\n2. Wait for any in-progress tick to complete (don't kill mid-dispatch)\n3. Close HTTP API server with context timeout (5s)\n4. Close SQLite store cleanly\n5. Log shutdown reason and duration\n\nREADME.md:\n- Architecture overview with ASCII diagram from plan\n- Quick start: build, configure cortex.toml, install systemd unit, start\n- Configuration reference: all cortex.toml sections with defaults\n- Provider setup: how to add/remove providers\n- Project setup: how to enable a new project (beads dir, workspace, agent creation)\n- Monitoring: how to query the HTTP API, where logs go\n- Troubleshooting: common issues (gateway down, rate limit hit, stuck tasks)\n\nAcceptance criteria:\n- Binary handles shutdown cleanly in all states (idle, mid-tick, mid-dispatch)\n- README covers all sections listed above\n- README is accurate to the actual implementation\n- No orphan processes left on shutdown","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":45,"created_at":"2026-02-17T14:26:28.456959192+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T15:03:00.120347648+10:00","closed_at":"2026-02-17T15:03:00.120347648+10:00","close_reason":"Closed","labels":["phase-5","polish"],"dependencies":[{"issue_id":"cortex-0kw.3","depends_on_id":"cortex-0kw","type":"parent-child","created_at":"2026-02-17T14:26:28.712913955+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-0kw.3","depends_on_id":"cortex-0kw.1","type":"blocks","created_at":"2026-02-17T14:26:28.73566296+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-0kw.3","depends_on_id":"cortex-0kw.2","type":"blocks","created_at":"2026-02-17T14:26:28.741505263+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-80e","title":"Phase 3: Self-Propelling Pipeline","description":"Multi-dispatch per tick (up to max_per_tick=3), auto-advance stuck stage labels, pipeline flush when downstream has 0 tasks but upstream completed, immediate child-unblock detection on bd close.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":240,"created_at":"2026-02-17T13:38:38.32962461+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:56:18.952234779+10:00","closed_at":"2026-02-17T14:56:18.952234779+10:00","close_reason":"Phase 3 complete","labels":["phase-3","pipeline"]}
{"id":"cortex-80e.1","title":"Multi-dispatch per tick","description":"Enhance the scheduler tick loop to dispatch up to max_per_tick (default 3) agents per tick across all projects, rather than just 1.\n\nChanges to scheduler.go RunTick():\n1. Collect all ready beads across all enabled projects into a single priority-sorted queue\n2. Dispatch up to max_per_tick from that merged queue\n3. Respect per-project ordering (higher priority project's beads sort first)\n4. If rate limiter blocks authed dispatch, still try free-tier beads from the queue\n5. Log: 'Dispatched {n}/{max} this tick, {remaining} ready beads queued'\n\nAlso add configurable per-project max_concurrent (default: 2) to prevent one project hogging all slots.\n\nAcceptance criteria:\n- Multiple agents dispatched in single tick when beads available\n- Per-project concurrent limit respected\n- Free-tier dispatches not blocked by authed rate limit exhaustion\n- Integration test with multiple projects and beads verifies dispatch ordering","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:21:03.114718461+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:56:18.675554601+10:00","closed_at":"2026-02-17T14:56:18.675554601+10:00","close_reason":"Pipeline features implemented","labels":["phase-3","pipeline"],"dependencies":[{"issue_id":"cortex-80e.1","depends_on_id":"cortex-80e","type":"parent-child","created_at":"2026-02-17T14:21:03.286932177+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-80e.1","depends_on_id":"cortex-08z.9","type":"blocks","created_at":"2026-02-17T14:21:03.352634985+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-80e.2","title":"Immediate child-unblock detection","description":"When a dispatch completes (detected during CheckRunningDispatches), immediately check if any of the completed bead's children/dependents are now unblocked, rather than waiting for the next tick.\n\nChanges:\n1. After marking a dispatch as completed in CheckRunningDispatches():\n   a. Get the bead ID that was just closed\n   b. Re-run ListBeads + BuildDepGraph for that project\n   c. Filter newly unblocked beads (beads whose last blocking dep was the just-completed bead)\n   d. If any newly unblocked AND within max_per_tick budget: dispatch immediately\n2. Log: 'Bead {id} completed, {n} children now unblocked, dispatching {m}'\n\nThis creates a reactive chain: as agents close beads, Cortex immediately picks up the next work without waiting 60s.\n\nAcceptance criteria:\n- Completing a bead triggers immediate check for newly unblocked children\n- Newly unblocked beads dispatched within same tick cycle\n- Still respects rate limits and max_per_tick\n- Does not re-dispatch already-running beads\n- Unit test: complete parent bead, verify child gets dispatched","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":45,"created_at":"2026-02-17T14:22:23.894750453+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:56:18.706061805+10:00","closed_at":"2026-02-17T14:56:18.706061805+10:00","close_reason":"Pipeline features implemented","labels":["phase-3","pipeline"],"dependencies":[{"issue_id":"cortex-80e.2","depends_on_id":"cortex-80e","type":"parent-child","created_at":"2026-02-17T14:22:23.946003135+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-80e.2","depends_on_id":"cortex-08z.9","type":"blocks","created_at":"2026-02-17T14:22:23.988987021+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-80e.3","title":"Pipeline flush for stalled downstreams","description":"Detect when a project's downstream beads have 0 open tasks but upstream beads have been completed, indicating the pipeline has stalled at a stage transition.\n\nLogic:\n1. After each tick, for each project:\n   a. Group beads by epic/parent\n   b. If an epic has all children closed -\u003e auto-close the epic via bd close\n   c. If all beads in a dependency chain are closed but the chain's root epic is still open -\u003e close it\n2. This prevents epics from staying open forever when all their children are done.\n\nAlso handle stage label advancement:\n- If a bead has label 'ready' and gets dispatched -\u003e could optionally update label to 'in-progress' via bd CLI\n- On completion -\u003e label updated to 'done' (or just bd close handles this)\n\nAcceptance criteria:\n- Epics auto-closed when all children are closed\n- No false positives (don't close epics with open children)\n- Handles nested epics (epic with child epics)\n- Unit test with sample bead graphs verifying auto-close logic","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":45,"created_at":"2026-02-17T14:22:41.309838405+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:56:18.726626735+10:00","closed_at":"2026-02-17T14:56:18.726626735+10:00","close_reason":"Pipeline features implemented","labels":["phase-3","pipeline"],"dependencies":[{"issue_id":"cortex-80e.3","depends_on_id":"cortex-80e","type":"parent-child","created_at":"2026-02-17T14:22:41.335299436+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-80e.3","depends_on_id":"cortex-08z.4","type":"blocks","created_at":"2026-02-17T14:22:41.356206295+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-80e.3","depends_on_id":"cortex-08z.9","type":"blocks","created_at":"2026-02-17T14:22:41.368733091+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-88b","title":"Phase 0: Cleanup \u0026 Archive Legacy Orchestration","description":"Archive all redundant orchestration tooling that Cortex replaces. Move to ~/backups/orchestration-legacy/. Disable old systemd services.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":30,"created_at":"2026-02-17T13:32:56.868558981+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:51.439494801+10:00","closed_at":"2026-02-17T14:48:51.439494801+10:00","close_reason":"Phase 0 complete","labels":["cleanup","phase-0"]}
{"id":"cortex-88b.1","title":"Archive redundant repos and scripts","description":"Create ~/backups/orchestration-legacy/ directory. Move: ~/orchestration/ (nearly empty), ~/gateway-monitor/ (redundant simple health script), ~/projects/command-center/ (FastAPI dashboard, replaced by Cortex API), select clawd scripts (auditor-check.sh, pane-babysitter.sh, flywheel-monitor.sh), clawd prompts (commander.md, coo-agent.md, project-auditor.md). Write ~/backups/orchestration-legacy/README.md documenting what was archived and why.\n\nAcceptance criteria:\n- All listed dirs/files moved to backup location\n- README.md describes each archived item\n- No broken symlinks left behind\n- Original locations cleaned up","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":15,"created_at":"2026-02-17T13:40:48.238110194+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:50.527087372+10:00","closed_at":"2026-02-17T14:48:50.527087372+10:00","close_reason":"Legacy dirs archived, services disabled","labels":["cleanup","phase-0"],"dependencies":[{"issue_id":"cortex-88b.1","depends_on_id":"cortex-88b","type":"parent-child","created_at":"2026-02-17T13:40:48.2410416+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-88b.2","title":"Disable legacy systemd services","description":"Stop and disable the old orchestration services that Cortex replaces:\n- openclaw-workflow.service (heartbeat orchestrator)\n- openclaw-workflow.timer (5-min trigger)\n\nCommands:\n  systemctl --user stop openclaw-workflow.timer openclaw-workflow.service\n  systemctl --user disable openclaw-workflow.timer openclaw-workflow.service\n\nAcceptance criteria:\n- Both services stopped and disabled\n- systemctl --user list-timers shows no openclaw-workflow entry\n- Gateway service (openclaw-gateway.service) remains running (Cortex uses it)","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":10,"created_at":"2026-02-17T13:41:23.335249561+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:48:50.591854037+10:00","closed_at":"2026-02-17T14:48:50.591854037+10:00","close_reason":"Legacy dirs archived, services disabled","labels":["cleanup","phase-0"],"dependencies":[{"issue_id":"cortex-88b.2","depends_on_id":"cortex-88b","type":"parent-child","created_at":"2026-02-17T13:41:23.340020989+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-f4n","title":"Phase 4: Self-Improving + Reporter","description":"Outcome detection (poll bd list for closed beads), duration tracking, weekly retro analysis of dispatches table, tier mismatch flagging, provider weight adjustment. Daily digest and event-driven alerts via Matrix through openclaw agent.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":240,"created_at":"2026-02-17T13:40:10.459102604+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:59:27.332196582+10:00","closed_at":"2026-02-17T14:59:27.332196582+10:00","close_reason":"Closed","labels":["learner","phase-4","reporter"]}
{"id":"cortex-f4n.1","title":"Outcome tracking + duration logging","description":"Implement internal/learner/outcomes.go — tracks task completion outcomes for learning.\n\nFunctions:\n- RecordOutcome(dispatch Dispatch, bead Bead) -\u003e error\n  Called when a dispatch transitions to completed or failed.\n  Records: bead_id, tier used, provider used, duration_s, exit_code, retries needed, escalated_from_tier.\n  \n- GetProviderStats(window time.Duration) -\u003e map[string]ProviderStats\n  Aggregates per-provider: total dispatches, avg duration, success rate, failure rate.\n  \n- GetTierAccuracy(window time.Duration) -\u003e map[string]TierAccuracy\n  Compares assigned tier vs actual duration:\n  - If a 'fast' tier task took \u003e90min -\u003e tier was underestimated\n  - If a 'premium' tier task took \u003c30min -\u003e tier was overestimated\n  Returns misclassification rate per tier.\n\n- GetProjectVelocity(project string, window time.Duration) -\u003e ProjectVelocity\n  Beads completed, avg time per bead, throughput (beads/day).\n\nAll data sourced from the dispatches table in store.\n\nAcceptance criteria:\n- Outcomes recorded on every dispatch completion\n- Provider stats accurately reflect success/failure rates\n- Tier accuracy detects misclassifications\n- Project velocity calculated correctly\n- Unit tests with seeded dispatch data","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:22:59.384589683+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:59:23.196454397+10:00","closed_at":"2026-02-17T14:59:23.196454397+10:00","close_reason":"Closed","labels":["learner","phase-4"],"dependencies":[{"issue_id":"cortex-f4n.1","depends_on_id":"cortex-f4n","type":"parent-child","created_at":"2026-02-17T14:22:59.405866381+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-f4n.1","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:22:59.427225835+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-f4n.2","title":"Weekly retrospective analysis","description":"Implement internal/learner/retro.go — generates a weekly retrospective report analyzing Cortex's performance.\n\nFunction:\n- GenerateWeeklyRetro() -\u003e RetroReport\n  Analyzes the past 7 days of dispatches data:\n  \n  1. Summary stats: total dispatches, completed, failed, stuck, avg duration\n  2. Provider performance: per-provider success rate, avg duration, failure modes\n  3. Tier accuracy: how often was the tier classification correct vs actual duration\n     - Underestimates (fast task took premium time) -\u003e suggest label adjustment\n     - Overestimates (premium task was trivial) -\u003e suggest downgrade\n  4. Project velocity: beads/day per project, backlog burn rate, ETA to empty\n  5. Rate limiter utilization: peak 5h window usage, weekly usage, headroom triggers\n  6. Recommendations: auto-generated suggestions like:\n     - 'Provider X had 40% failure rate — consider deprioritizing'\n     - 'Tier fast is overloaded — raise threshold to 45min'\n     - 'Project Y stalled — 0 beads completed in 3 days'\n\n- FormatRetroMarkdown(report RetroReport) -\u003e string\n  Formats the report as a clean markdown message suitable for Matrix delivery.\n\nScheduled: runs on config.Reporter.WeeklyRetroDay (default: Monday).\n\nAcceptance criteria:\n- Retro covers all 5 analysis dimensions\n- Recommendations are actionable and specific\n- Markdown output is clean and readable\n- Unit tests with seeded week of dispatch data\n- Handles edge case: no dispatches in the past week","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:24:18.47563934+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:59:23.214396431+10:00","closed_at":"2026-02-17T14:59:23.214396431+10:00","close_reason":"Closed","labels":["learner","phase-4"],"dependencies":[{"issue_id":"cortex-f4n.2","depends_on_id":"cortex-f4n","type":"parent-child","created_at":"2026-02-17T14:24:18.494227535+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-f4n.2","depends_on_id":"cortex-f4n.1","type":"blocks","created_at":"2026-02-17T14:24:18.649189004+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-f4n.3","title":"Daily digest + event-driven Matrix alerts","description":"Implement Matrix integration for Cortex reporting via openclaw agent dispatch.\n\nDaily digest (scheduled at config.Reporter.DailyDigestTime, default 09:00 AEST):\n- Dispatches the 'main' agent with a formatted status message:\n  ## Daily Cortex Digest — {date}\n  - **{project}:** {completed} beads completed, {ready} ready, {running} in progress\n  - **Providers:** {provider} {used}/{cap} for each authed provider\n  - **Health:** {events_count} events, {restarts} restarts\n  - **Next up:** {top_3_ready_beads}\n\n- Command: openclaw agent --agent main --message {digest} --deliver --reply-channel matrix --reply-to {room_id}\n\nEvent-driven alerts (immediate, not scheduled):\nCortex sends immediate alerts for:\n1. Task failed after max retries -\u003e includes bead ID, error details, retry history\n2. Gateway down for \u003e5min -\u003e includes restart attempts, last error\n3. Provider weekly quota \u003e80% -\u003e includes current usage, projected depletion\n\nImplementation:\n- internal/reporter/reporter.go with Reporter struct\n- SendDigest() method for daily digest\n- SendAlert(alertType, message) for event-driven alerts\n- Both use dispatcher.Dispatch to send via openclaw agent\n\nAcceptance criteria:\n- Daily digest sent at configured time with accurate stats\n- Event alerts sent immediately on trigger conditions\n- Messages formatted as readable markdown\n- Does not send duplicate alerts for same event within 1h (dedup)\n- Unit tests verify message formatting and dedup logic","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:25:20.620008341+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:59:23.233750686+10:00","closed_at":"2026-02-17T14:59:23.233750686+10:00","close_reason":"Closed","labels":["phase-4","reporter"],"dependencies":[{"issue_id":"cortex-f4n.3","depends_on_id":"cortex-f4n","type":"parent-child","created_at":"2026-02-17T14:25:20.645509375+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-f4n.3","depends_on_id":"cortex-08z.8","type":"blocks","created_at":"2026-02-17T14:25:20.725842446+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-f4n.3","depends_on_id":"cortex-f4n.1","type":"blocks","created_at":"2026-02-17T14:25:20.80543788+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-tyl","title":"Phase 2: Health \u0026 Self-Healing","description":"Gateway monitoring, stuck task detection with tier escalation, zombie process cleanup, flock mutex for single-instance enforcement. Runs as separate goroutine on 2min interval.","status":"closed","priority":2,"issue_type":"epic","owner":"simon.heikkila@gmail.com","estimated_minutes":240,"created_at":"2026-02-17T13:37:53.458300888+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:55:46.340134573+10:00","closed_at":"2026-02-17T14:55:46.340134573+10:00","close_reason":"Phase 2 complete","labels":["health","phase-2"]}
{"id":"cortex-tyl.1","title":"Gateway health monitor","description":"Implement internal/health/health.go — monitors the OpenClaw gateway service.\n\nFunction:\n- CheckGateway(unitName string) -\u003e HealthStatus\n  1. Run: systemctl --user is-active {unitName}\n  2. If inactive -\u003e attempt restart: systemctl --user restart {unitName}\n  3. If restart fails -\u003e check for stale locks/PIDs in /tmp/openclaw-gateway*, clear them, retry\n  4. Record health event to store (gateway_restart type)\n  5. Track restart count in rolling 1h window\n  6. If 3+ restarts in 1h -\u003e return critical status (triggers Matrix alert upstream)\n\nRuns as separate goroutine on config.Health.CheckInterval (default 2min).\n\nAcceptance criteria:\n- Detects inactive gateway and restarts it\n- Clears stale lock files on restart failure\n- Records all health events to SQLite\n- Escalates to alert after 3 restarts in 1h\n- Unit tests mock systemctl commands","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:13:05.776280397+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:55:46.02130734+10:00","closed_at":"2026-02-17T14:55:46.02130734+10:00","close_reason":"Phase 2 health modules implemented with tests","labels":["health","phase-2"],"dependencies":[{"issue_id":"cortex-tyl.1","depends_on_id":"cortex-tyl","type":"parent-child","created_at":"2026-02-17T14:13:05.780322968+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.1","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:13:05.786912944+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-tyl.2","title":"Stuck task detection + tier escalation","description":"Implement internal/health/stuck.go — detects dispatched tasks that have been running too long and handles retries with tier escalation.\n\nFunction:\n- CheckStuckDispatches(timeout duration, maxRetries int) -\u003e []StuckAction\n  1. Query store.GetStuckDispatches(timeout) — dispatches WHERE status=running AND dispatched_at \u003c now()-timeout\n  2. For each stuck dispatch:\n     a. Check if PID is still alive (kill -0 pid)\n     b. If PID dead -\u003e mark status=failed in store\n     c. If PID alive but past timeout -\u003e kill it (SIGTERM, wait 5s, SIGKILL)\n     d. If retries \u003c maxRetries: re-dispatch with escalated tier (fast-\u003ebalanced-\u003epremium)\n        Set escalated_from_tier on new dispatch record\n     e. If retries \u003e= maxRetries -\u003e mark status=failed, log, return alert action\n  3. Record health events for each action taken\n\nAcceptance criteria:\n- Correctly identifies stuck dispatches past timeout\n- Dead PIDs detected and cleaned up\n- Alive-but-stuck PIDs killed gracefully\n- Tier escalation works: fast-\u003ebalanced-\u003epremium\n- Stops retrying after maxRetries, flags for alert\n- Unit tests with mock PID checks and store data","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":60,"created_at":"2026-02-17T14:19:24.632167247+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:55:46.044554518+10:00","closed_at":"2026-02-17T14:55:46.044554518+10:00","close_reason":"Phase 2 health modules implemented with tests","labels":["health","phase-2"],"dependencies":[{"issue_id":"cortex-tyl.2","depends_on_id":"cortex-tyl","type":"parent-child","created_at":"2026-02-17T14:19:24.646193963+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.2","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:19:24.70179185+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.2","depends_on_id":"cortex-08z.8","type":"blocks","created_at":"2026-02-17T14:19:24.724537621+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-tyl.3","title":"Zombie process cleanup","description":"Implement internal/health/zombie.go — finds orphaned openclaw agent processes that have no matching dispatch record.\n\nFunction:\n- CleanZombies() -\u003e int (count killed)\n  1. Run: pgrep -f 'openclaw agent' to get all PIDs running openclaw agents\n  2. Query store.GetRunningDispatches() to get all tracked PIDs\n  3. Any PID from pgrep NOT in the dispatches table is an orphan\n  4. Kill orphans: SIGTERM, wait 5s, SIGKILL if still alive\n  5. Record health event for each zombie killed (zombie_killed type)\n  6. Return count of killed processes\n\nCalled from the health check goroutine on each interval.\n\nAcceptance criteria:\n- Correctly identifies orphan processes (PID exists but no dispatch record)\n- Does NOT kill processes that are tracked in dispatches\n- Graceful kill with SIGTERM fallback to SIGKILL\n- Records health events for audit trail\n- Unit tests with mock pgrep output and store data","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":30,"created_at":"2026-02-17T14:20:27.342833336+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:55:46.083012475+10:00","closed_at":"2026-02-17T14:55:46.083012475+10:00","close_reason":"Phase 2 health modules implemented with tests","labels":["health","phase-2"],"dependencies":[{"issue_id":"cortex-tyl.3","depends_on_id":"cortex-tyl","type":"parent-child","created_at":"2026-02-17T14:20:27.385269769+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.3","depends_on_id":"cortex-08z.3","type":"blocks","created_at":"2026-02-17T14:20:27.430397688+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.3","depends_on_id":"cortex-08z.8","type":"blocks","created_at":"2026-02-17T14:20:27.496748999+10:00","created_by":"Simon Heikkila"}]}
{"id":"cortex-tyl.4","title":"Single-instance flock mutex","description":"Add flock-based mutex to cmd/cortex/main.go so only one Cortex instance can run at a time.\n\nOn startup:\n1. Open lock file at /tmp/cortex.lock (or config-specified path)\n2. Attempt flock(LOCK_EX | LOCK_NB)\n3. If lock fails -\u003e log 'Another Cortex instance is running', exit 1\n4. Hold lock for lifetime of process (released on exit)\n\nUse syscall.Flock in Go.\n\nAcceptance criteria:\n- Second instance exits immediately with clear error message\n- Lock released cleanly on normal exit and SIGTERM\n- Unit test: start two instances, verify second fails","status":"closed","priority":2,"issue_type":"task","owner":"simon.heikkila@gmail.com","estimated_minutes":15,"created_at":"2026-02-17T14:20:43.885573502+10:00","created_by":"Simon Heikkila","updated_at":"2026-02-17T14:55:46.101392206+10:00","closed_at":"2026-02-17T14:55:46.101392206+10:00","close_reason":"Phase 2 health modules implemented with tests","labels":["health","phase-2"],"dependencies":[{"issue_id":"cortex-tyl.4","depends_on_id":"cortex-tyl","type":"parent-child","created_at":"2026-02-17T14:20:43.902052012+10:00","created_by":"Simon Heikkila"},{"issue_id":"cortex-tyl.4","depends_on_id":"cortex-08z.10","type":"blocks","created_at":"2026-02-17T14:20:43.922396179+10:00","created_by":"Simon Heikkila"}]}
